# Story 5.3: Open Tickets Dashboard Integration

## Status
**Ready for Review**

## Story
**As a** user,
**I want** to see my open tickets on the dashboard,
**so that** I have visibility of current work (FR10).

## Acceptance Criteria
1. Dashboard includes "Open Tickets" section showing all currently open tickets
2. Section displays ticket ID, client name, contact name, total hours, last updated date
3. Tickets sorted by most recently updated first
4. Each ticket row clickable to navigate to ticket detail
5. Section shows empty state message if no open tickets
6. Total count of open tickets displayed in section header
7. Section includes "View All" link to dedicated open tickets page if list is long (>20 items)
8. Pagination or "show more" functionality if open ticket count exceeds 20
9. Quick actions available: "Edit" icon/button for inline navigation to ticket detail

## Tasks / Subtasks

> **NOTE FROM SCRUM MASTER:** According to the codebase analysis, most of this story has already been implemented during earlier development work (Stories 5.1 and 5.2). The primary gaps are: (1) Verifying tickets are sorted by `updatedAt`, (2) Ensuring "View All" link for open tickets works correctly, and (3) Adding "Edit" icon/button for quick navigation.

- [x] Task 1: Verify backend endpoint for open tickets (AC: 1, 3)
  - [x] Confirm `GET /api/tickets?state=open` endpoint exists
  - [x] Verify endpoint returns tickets with state='open'
  - [x] Verify tickets are sorted by `updatedAt DESC` (most recent first)
  - [x] Test authentication requirement

- [x] Task 2: Verify frontend hook and API service (AC: 1)
  - [x] Confirm `useOpenTickets()` hook exists in `frontend/src/hooks/useTickets.ts`
  - [x] Verify `ticketsApi.getAll({ state: 'open' })` service method exists
  - [x] Check React Query configuration for cache invalidation on ticket updates

- [x] Task 3: Verify Dashboard displays Open Tickets section (AC: 1, 2, 4, 5, 6)
  - [x] Confirm "Open Tickets" section exists in Dashboard component
  - [x] Verify section displays: ticket ID, client name, contact name, total hours, updated date
  - [x] Check empty state message displays when no open tickets
  - [x] Verify clicking ticket row navigates to ticket detail page
  - [x] Verify open ticket count badge in section header

- [x] Task 4: Verify ticket sorting by `updatedAt` (AC: 3) **NEEDS VERIFICATION**
  - [x] Check backend endpoint query includes `ORDER BY updated_at DESC`
  - [x] Verify frontend displays tickets in order returned by backend
  - [x] Test: Update a ticket → Verify it moves to top of list
  - [x] If not sorting correctly, implement sorting logic

- [x] Task 5: Verify "View All" link for open tickets (AC: 7) **NEEDS VERIFICATION**
  - [x] Check if open tickets count > 20 triggers "View All" link display
  - [x] Verify "View All" link navigates to `/tickets?state=open`
  - [x] Test with >20 open tickets (may require test data)
  - [x] Ensure TicketsPage properly handles `state=open` filter

- [x] Task 6: Verify pagination/show more for >20 tickets (AC: 8)
  - [x] Confirm Dashboard displays first 20 tickets only (slice logic)
  - [x] Check "View All" link displays when more than 20 tickets exist
  - [x] Verify clicking "View All" shows full list on TicketsPage
  - [x] Note: Full pagination can be deferred if TicketsPage shows all tickets

- [x] Task 7: Add Edit icon/button for quick navigation (AC: 9) **NEEDS IMPLEMENTATION**
  - [x] Update TicketRow component to include "Edit" icon/button
  - [x] Position icon/button to right side of ticket row
  - [x] Wire up click handler to navigate to `/tickets/:id`
  - [x] Ensure icon doesn't trigger row click (stopPropagation)
  - [x] Add icon to desktop table row (`variant="desktop"`) and mobile card variants ONLY
  - [x] DO NOT add Edit icon to `variant="desktop-closed"` (Recently Closed section)
  - [x] Test on desktop and mobile viewports

- [x] Task 8: Testing (AC: all)
  - [x] Test open tickets fetch and display
  - [x] Verify tickets sorted by most recently updated first
  - [x] Test clicking ticket row navigates to detail page
  - [x] Test empty state when no open tickets
  - [x] Test "View All" link with >20 tickets
  - [x] Test Edit icon click navigates correctly
  - [x] Test mobile card layout displays all information
  - [x] Manual testing on desktop and mobile viewports

## Dev Notes

### Important Context
**This story builds on existing Dashboard functionality implemented in [Story 5.1](docs/stories/5.1.dashboard-layout-navigation.md) and [Story 5.2](docs/stories/5.2.recently-closed-tickets-view.md).** The Open Tickets section is already displayed on the Dashboard with most required functionality. The primary work needed is:

1. **Verify tickets are sorted by `updatedAt DESC`** (most recently updated first)
2. **Verify "View All" link works correctly** for open tickets when count > 20
3. **Add Edit icon/button to ticket rows** for quick navigation to detail page

### Previous Story Insights
[Source: Story 5.1 and 5.2 implementation]
- Dashboard component already displays Open Tickets section with ticket data
- Backend endpoint `GET /api/tickets?state=open` returns open tickets
- React Query hooks (`useOpenTickets`) established with 5-minute staleTime
- TicketRow component used for both open and closed ticket display
- Dashboard limits display to first 20 tickets with "View All" link
- TicketsPage supports state filtering via URL query params (`?state=open`)

**VERIFIED:** The open tickets functionality exists in the codebase:
- Backend: `backend/src/routes/tickets.js` and `backend/src/controllers/ticketController.js`
- Frontend hook: `frontend/src/hooks/useTickets.ts:25` (`useOpenTickets`)
- Frontend API service: `frontend/src/lib/api/tickets.ts`
- Dashboard component: `frontend/src/components/Dashboard.tsx:82-160`

**Gap Identified:** Need to verify backend sorting by `updatedAt` and add Edit icon to TicketRow.

### Relevant Source Tree
**Frontend:**
- `frontend/src/components/Dashboard.tsx` - Main dashboard with Open Tickets section (lines 82-160)
- `frontend/src/components/TicketRow.tsx` - Ticket row component (needs Edit icon addition)
- `frontend/src/pages/Index.tsx` - Dashboard page that orchestrates data fetching
- `frontend/src/pages/TicketsPage.tsx` - Full tickets list page with state filtering
- `frontend/src/hooks/useTickets.ts` - React Query hooks (`useOpenTickets`)
- `frontend/src/lib/api/tickets.ts` - API service with `getAll()` method

**Backend:**
- `backend/src/routes/tickets.js` - Route: `GET /api/tickets`
- `backend/src/controllers/ticketController.js` - Controller: `getAllTickets()`
- `backend/src/models/Ticket.js` - Model with `findAll()` method

### Data Models
[Source: docs/architecture/data-models.md]

**Ticket Interface (with display fields):**
```typescript
interface Ticket {
  id: number;
  clientId: number;
  clientName: string;          // Populated via JOIN
  contactId: number;
  contactName: string;          // Populated via JOIN
  description: string | null;
  notes: string | null;
  state: 'open' | 'closed';
  closedAt: string | null;
  totalHours: number;           // Computed from time entries
  createdAt: string;            // ISO timestamp
  updatedAt: string;            // ISO timestamp - USED FOR SORTING
}
```

**Sorting Requirement:**
- Tickets must be sorted by `updatedAt DESC` (most recently updated first)
- Backend should handle sorting in SQL query
- Frontend displays tickets in order returned by backend

### API Specifications
[Source: docs/architecture/api-specification.md]

**Open Tickets Endpoint:**
- **GET** `/api/tickets?state=open`
- **Auth:** Required (session-based)
- **Query Params:**
  - `state=open` - Filter by ticket state
- **Response:** Array of Ticket objects
  ```json
  [
    {
      "id": 42,
      "clientId": 5,
      "clientName": "Acme Corp",
      "contactId": 12,
      "contactName": "John Doe",
      "description": "Fix login bug",
      "notes": "User reported issue",
      "state": "open",
      "closedAt": null,
      "canReopen": null,
      "totalHours": 2.5,
      "createdAt": "2025-10-04T10:00:00.000Z",
      "updatedAt": "2025-10-06T14:30:00.000Z"
    }
  ]
  ```

**Sorting Specification:**
- Tickets sorted by `updated_at DESC` in SQL query
- Frontend relies on backend sorting order

### Component Specifications
[Source: Existing implementation]

**Dashboard Component - Open Tickets Section:**
Current implementation (lines 82-160 in Dashboard.tsx):
- Displays Open Tickets in left column (desktop) or main section (mobile)
- Shows ticket count badge in section header
- Empty state when no open tickets
- Uses TicketRow component with `variant="desktop"` or `variant="mobile"`
- Limits display to first 20 tickets: `openTickets.slice(0, 20)`
- Shows "View All ([count])" link when more than 20 tickets exist

**Required Changes:**
1. Add Edit icon/button to TicketRow component
2. Verify backend sorting by `updatedAt DESC`
3. Ensure "View All" link navigates to correct page

**TicketRow Component:**
Current implementation supports multiple variants:
- `variant="desktop"` - Table row for desktop view (OPEN tickets)
- `variant="desktop-closed"` - Compact table row for closed tickets (Recently Closed section)
- `variant="mobile"` - Card layout for mobile view

**Required Changes:**
1. Add Edit icon/button (e.g., Pencil icon from lucide-react)
2. Position icon to right side of row
3. Add `onClick` handler with `e.stopPropagation()` to prevent row click
4. Add to `variant="desktop"` and `variant="mobile"` ONLY
5. DO NOT add Edit icon to `variant="desktop-closed"` (Recently Closed tickets don't need Edit icon)

**Example Implementation:**
```tsx
// In TicketRow component - Add Edit icon for desktop and mobile variants only
{variant !== 'desktop-closed' && onEdit && (
  <button
    onClick={(e) => {
      e.stopPropagation();
      onEdit(ticket.id);
    }}
    className="text-muted-foreground hover:text-foreground"
  >
    <Pencil className="w-4 h-4" />
  </button>
)}
```

### Business Logic: Ticket Sorting
[Source: Story 5.3 AC 3, database schema]

**Sorting Rule:**
- Tickets sorted by `updated_at DESC` (most recently modified first)
- `updated_at` timestamp updates whenever:
  - Ticket description/notes changed
  - Ticket state changed (open → closed or closed → open)
  - Time entry added/updated/deleted (if implemented to update parent ticket)

**Backend Implementation:**
```sql
SELECT * FROM tickets
WHERE state = 'open'
ORDER BY updated_at DESC;
```

**Frontend Display:**
- Frontend displays tickets in order returned by backend
- No client-side sorting needed if backend handles it correctly

### React Query Cache Invalidation
[Source: frontend/src/hooks/useTickets.ts]

**Query Keys:**
- Open Tickets: `['tickets', 'list', 'state=open']`
- Dashboard Stats: `['tickets', 'stats']`

**On Ticket Update:**
```typescript
onSuccess: (_, { id }) => {
  // Invalidate both list and detail queries
  queryClient.invalidateQueries({ queryKey: ticketKeys.lists() });
  queryClient.invalidateQueries({ queryKey: ticketKeys.detail(id) });
  queryClient.invalidateQueries({ queryKey: ticketKeys.recentlyClosed() });
  queryClient.invalidateQueries({ queryKey: ticketKeys.stats() });
}
```

This ensures Dashboard updates automatically when a ticket is created, updated, or closed.

### "View All" Link Implementation
[Source: Dashboard.tsx lines 150-156, TicketsPage.tsx]

**Current Implementation:**
- Dashboard displays "View All ([count])" link when `openTickets.length > 20`
- Link should navigate to `/tickets?state=open`
- TicketsPage component handles state filtering via URL query params

**Required Verification:**
1. Confirm link navigates to correct URL
2. Verify TicketsPage properly filters tickets by `state=open`
3. Test with >20 open tickets (may require test data)

**Implementation in Dashboard:**
```tsx
{openTickets.length > 20 && (
  <div className="px-6 py-4 border-t border-border text-center">
    <button
      onClick={() => navigate('/tickets?state=open')}
      className="text-primary hover:text-primary/80 text-sm font-medium"
    >
      View All ({openTickets.length})
    </button>
  </div>
)}
```

### Technical Constraints
[Source: docs/architecture/tech-stack.md]
- **UI Components:** Use shadcn/ui (Button, icons from lucide-react)
- **State Management:** React Query for mutations and cache invalidation
- **Navigation:** React Router `useNavigate()` hook
- **Icons:** lucide-react library (e.g., Pencil for Edit icon)
- **Styling:** Tailwind CSS utility classes

### Testing

**Test Standards:**
[Source: docs/architecture/testing-strategy.md]
- Manual browser testing for MVP
- Test on desktop and mobile viewports
- Backend tests using Node.js native test runner

**Key Test Scenarios:**
1. **Open Tickets Display:**
   - Create multiple open tickets → Verify they appear in Open Tickets section
   - Verify displays: ticket ID, client name, contact name, total hours, updated date
   - Verify empty state when no open tickets

2. **Ticket Sorting:**
   - Create ticket A, then ticket B → Ticket B should appear first (most recent)
   - Update ticket A description → Ticket A should move to top of list
   - Close a ticket → Verify it disappears from Open Tickets section

3. **Clickable Rows:**
   - Click ticket row → Should navigate to `/tickets/:id` detail page
   - Verify navigation works on both desktop and mobile

4. **View All Link:**
   - Create >20 open tickets → "View All" link should appear
   - Click "View All" → Should navigate to `/tickets?state=open`
   - Verify TicketsPage displays all open tickets with proper filtering

5. **Edit Icon:**
   - Click Edit icon → Should navigate to `/tickets/:id` detail page
   - Verify clicking Edit icon does NOT trigger row click
   - Test on both desktop table and mobile card layouts

6. **Real-time Updates:**
   - Create ticket → Open Tickets section updates automatically
   - Update ticket description → Section updates and ticket moves to top
   - Close ticket → Ticket disappears from Open Tickets, appears in Recently Closed

7. **Mobile Responsiveness:**
   - Open Tickets display correctly in mobile card layout
   - Edit icon displays correctly on mobile
   - All information readable on small viewports (320px)

**Running Tests:**
```bash
# Manual testing workflow
1. npm --prefix frontend run dev
2. npm --prefix backend start
3. Login to application
4. Create multiple open tickets with different timestamps
5. Verify tickets display in correct order (most recent first)
6. Click ticket row → Verify navigation to detail page
7. Create >20 tickets → Verify "View All" link appears
8. Click Edit icon → Verify navigation works correctly
9. Test edge cases (no open tickets, empty state)
```

**Backend Tests:**
Existing tests in `backend/src/controllers/__tests__/ticketController.test.js` should cover:
- `GET /api/tickets?state=open` returns only open tickets
- Tickets sorted by `updated_at DESC`
- Response includes all required fields (id, clientName, contactName, totalHours, updatedAt)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-10-06 | 1.1 | Implementation complete - Added View All handler and Edit icons | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
_None_

### Completion Notes List
- Backend ticket sorting by `updatedAt DESC` was already implemented in Ticket.findAll() at line 145
- Frontend displays tickets in order returned by backend without client-side sorting
- Added "View All" navigation handler for open tickets to Index.tsx and Dashboard.tsx
- Added Edit icon (Pencil from lucide-react) to TicketRow component for desktop and mobile variants only
- Edit icon uses stopPropagation to prevent triggering row click
- Added "Actions" column header to Open Tickets table for Edit icon
- Edit icon NOT added to desktop-closed variant (Recently Closed section) as per requirements
- All pre-existing linting errors remain unchanged (not introduced by this story)

### File List
**Modified:**
- frontend/src/pages/Index.tsx - Added handleViewAllOpen handler
- frontend/src/components/Dashboard.tsx - Added onViewAllOpen prop, wired up View All button, added Actions column header, passed onEdit prop to TicketRow
- frontend/src/components/TicketRow.tsx - Added onEdit prop, Pencil icon import, Edit button for desktop and mobile variants

## QA Results
_Not yet tested_
