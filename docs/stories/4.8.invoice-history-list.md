# Story 4.8: Invoice History List

## Status
**Ready for Review**

## Story
**As a** user,
**I want** to view a list of all generated invoices with the ability to delete individual invoices,
**so that** I can track my invoicing history and correct mistakes by re-invoicing if needed.

## Acceptance Criteria
1. Invoice Review page (`/invoices`) displays real data from `invoice_locks` table instead of mock data
2. Page shows list of all months that have been invoiced, grouped by month
3. Each invoice entry displays: month name, lock date/time, number of Xero invoice IDs, total billable hours for that month
4. "Generate Invoices" button removed from the invoice list page (functionality already exists in `/invoices/preview`)
5. Each invoice entry has a "Delete" action button/icon
6. Clicking "Delete" shows confirmation dialog: "Delete invoice lock for [Month YYYY]? This will allow time entries for this month to be edited and re-invoiced. This does NOT delete the invoice in Xero."
7. User confirms deletion, system calls delete API endpoint
8. Successful deletion removes the invoice_lock record from database
9. After deletion, month becomes editable again and can be re-invoiced via `/invoices/preview`
10. Delete action requires authentication
11. Error handling for delete failures (database errors, network errors)
12. Page shows empty state when no invoices have been generated yet
13. Loading state shown while fetching invoice data
14. List sorted by month descending (most recent first)

## Tasks / Subtasks

- [x] Task 1: Create backend API endpoint for fetching invoice history (AC: 1, 2, 3, 14)
  - [x] Add GET route `/api/invoices/history` to `backend/src/routes/invoices.js`
  - [x] Create controller function `getInvoiceHistory` in `backend/src/controllers/invoiceController.js`
  - [x] Query `invoice_locks` table: `SELECT * FROM invoice_locks ORDER BY month DESC`
  - [x] For each invoice lock, aggregate total billable hours from associated time entries for that month
  - [x] Return JSON array: `[{ id, month, lockedAt, xeroInvoiceIds, totalBillableHours, clientCount }]`
  - [x] Add authentication middleware `requireAuth`
  - [x] Handle errors and return appropriate status codes

- [x] Task 2: Create backend API endpoint for deleting invoice locks (AC: 5, 6, 7, 8, 9, 11)
  - [x] Add DELETE route `/api/invoices/:id` to `backend/src/routes/invoices.js`
  - [x] Create controller function `deleteInvoiceLock` in `backend/src/controllers/invoiceController.js`
  - [x] Delete record from `invoice_locks` table by id: `DELETE FROM invoice_locks WHERE id = $1`
  - [x] Return success response with message
  - [x] Add authentication middleware `requireAuth`
  - [x] Handle errors: record not found (404), database errors (500)
  - [x] Add transaction handling if needed

- [x] Task 3: Create frontend API service for invoice history (AC: 1, 5)
  - [x] Add to `frontend/src/lib/api/invoices.ts`
  - [x] Function: `getInvoiceHistory()` calls `GET /api/invoices/history`
  - [x] Function: `deleteInvoiceLock(id: number)` calls `DELETE /api/invoices/:id`
  - [x] Define TypeScript types: `InvoiceHistoryItem` with fields: `id`, `month`, `lockedAt`, `xeroInvoiceIds`, `totalBillableHours`, `clientCount`
  - [x] Handle error responses

- [x] Task 4: Create React Query hooks for invoice history (AC: 1, 5, 8, 9, 13)
  - [x] Create new file `frontend/src/hooks/useInvoiceHistory.ts`
  - [x] Hook: `useInvoiceHistory()` for fetching invoice list
  - [x] Hook: `useDeleteInvoiceLock()` mutation for deleting invoice locks
  - [x] Configure query caching and refetching
  - [x] On successful delete: invalidate and refetch invoice history query
  - [x] Return loading, error, and data states

- [x] Task 5: Replace mock data in InvoiceReview component with real data (AC: 1, 2, 3, 12, 13, 14)
  - [x] Update `frontend/src/components/InvoiceReview.tsx`
  - [x] Remove `generateMockData` function and all mock data generation
  - [x] Use `useInvoiceHistory()` hook to fetch real invoice data
  - [x] Update component to display invoice history instead of invoice preview
  - [x] Show loading skeleton while data is fetching
  - [x] Show empty state when no invoices exist: "No invoices generated yet. Visit Invoice Preview to generate your first invoice."
  - [x] Update layout to show invoice history list instead of client groups
  - [x] Remove month selector (show all months in history)

- [x] Task 6: Remove "Generate Invoices" button from InvoiceReview page (AC: 4)
  - [x] Remove `GenerateInvoicesDialog` component import and usage
  - [x] Remove `InvoiceSuccessDialog` component import and usage
  - [x] Remove all invoice generation logic and state management
  - [x] Remove action bar with "Generate Invoices" button
  - [x] Add navigation link/button to `/invoices/preview` instead for generating new invoices

- [x] Task 7: Add delete functionality to invoice list (AC: 5, 6, 7, 8, 9, 11)
  - [x] Add "Delete" button/icon to each invoice entry in the list
  - [x] Create confirmation dialog component or use existing AlertDialog
  - [x] Dialog message: "Delete invoice lock for [Month YYYY]? This will allow time entries for this month to be edited and re-invoiced. This does NOT delete the invoice in Xero."
  - [x] On confirm: call `deleteInvoiceLock` mutation
  - [x] Show loading state during deletion
  - [x] Show success toast notification
  - [x] Handle errors: display error message in dialog or toast
  - [x] Close dialog on success or error
  - [x] Use `useDeleteInvoiceLock()` hook

- [x] Task 8: Update invoice list UI to display real data (AC: 2, 3, 14)
  - [x] Create or update invoice history card/row component
  - [x] Display month name (e.g., "October 2025")
  - [x] Display lock date/time formatted nicely
  - [x] Display count of Xero invoice IDs (e.g., "3 invoices")
  - [x] Display total billable hours for that month
  - [x] Display client count if available
  - [x] Sort list by month descending (most recent first)
  - [x] Apply consistent styling with rest of application

- [x] Task 9: Add TypeScript types (AC: 1, 3)
  - [x] Add to `frontend/src/types/invoice.ts`
  - [x] Type: `InvoiceHistoryItem` with fields: `id: number`, `month: string`, `lockedAt: string`, `xeroInvoiceIds: string[]`, `totalBillableHours: number`, `clientCount: number`
  - [x] Type: `DeleteInvoiceLockResponse` with fields: `success: boolean`, `message: string`

- [x] Task 10: Testing (AC: all)
  - [x] Test fetching invoice history list
  - [x] Test empty state when no invoices
  - [x] Test delete confirmation dialog flow
  - [x] Test successful deletion and list refresh
  - [x] Test error handling for failed deletions
  - [x] Test that deleted month can be re-invoiced
  - [x] Verify authentication required for all endpoints
  - [x] Test loading states and error states

## Dev Notes

### Relevant Source Tree
**Backend:**
- `backend/src/routes/invoices.js` - Invoice routes (add new routes here)
- `backend/src/controllers/invoiceController.js` - Invoice controller functions
- `backend/src/models/InvoiceLock.js` - InvoiceLock model if exists, or use raw SQL queries

**Frontend:**
- `frontend/src/components/InvoiceReview.tsx` - Main invoice review page (currently uses mock data)
- `frontend/src/lib/api/invoices.ts` - Invoice API service functions
- `frontend/src/hooks/useInvoicePreview.ts` - Invoice preview hooks
- `frontend/src/types/invoice.ts` - Invoice TypeScript types

**Database:**
- Table: `invoice_locks` with columns: `id`, `month`, `xero_invoice_ids` (jsonb), `locked_at`

### Integration Approach
This story integrates with the existing invoice system by:
1. Reading from the `invoice_locks` table created in Story 4.2
2. Allowing deletion of invoice lock records to enable re-invoicing
3. Using existing authentication middleware from Story 1.3
4. Following existing API patterns from Stories 4.3 and 4.4
5. Reusing existing UI components and styles from Stories 4.5 and 4.6

### Key Constraints
- Deleting an invoice lock DOES NOT delete the actual invoice in Xero
- Users must manually void/delete invoices in Xero if needed
- After deletion, time entries for that month become editable again
- Users can re-generate invoices for the month via `/invoices/preview`
- This is a destructive action and requires user confirmation

### Existing Patterns to Follow
- Use `requireAuth` middleware for protected routes
- Follow camelCase/snake_case transformation pattern from existing API services
- Use React Query for data fetching and mutations
- Use shadcn/ui components (Dialog, Button, Alert) for consistency
- Follow existing error handling patterns with try/catch and appropriate status codes
- Use toast notifications for success/error messages (existing pattern in app)

### Important Notes from Previous Stories
- Invoice locks are created when invoices are successfully generated (Story 4.4)
- Locked months prevent time entry editing (Story 4.2)
- The `xero_invoice_ids` field stores an array of Xero invoice IDs as JSONB
- Authentication is required for all invoice-related operations
- The app uses PostgreSQL with pg library for database operations

### Testing
**Test Standards:**
- Backend tests: Use Node.js native test runner
- Test file location: `backend/src/controllers/__tests__/invoiceController.test.js` (add new tests here)
- Mock database calls using test database or mocks
- Test authentication requirements
- Test error cases (not found, database errors)

**Frontend tests:**
- Component tests: Not currently required but can be added
- Integration tests: Manual testing of UI flows
- Test invoice history fetch, display, and deletion flow end-to-end

**Testing Framework:**
- Backend: Node.js native test runner (`node --test`)
- Database: Test database or mocked pg client
- Run tests: `NODE_OPTIONS="--no-warnings" node --test backend/src/controllers/__tests__/invoiceController.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Initial story creation | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes List
- Implemented GET /api/invoices/history endpoint with aggregated billable hours and client counts
- Implemented DELETE /api/invoices/:id endpoint with proper error handling (404, 400, 500)
- Created TypeScript types for InvoiceHistoryItem and DeleteInvoiceLockResponse
- Created React Query hooks (useInvoiceHistory, useDeleteInvoiceLock) with automatic cache invalidation
- Completely rebuilt InvoiceReview component to display history instead of preview/generation
- Removed all mock data and invoice generation logic from InvoiceReview
- Added delete confirmation dialog with proper warning message about Xero invoices
- Implemented loading states, empty states, and error handling in UI
- Frontend linting: PASSED (0 errors in new code)
- TypeScript compilation: PASSED (0 errors)
- Backend tests created for new endpoints with comprehensive coverage

**Bug Fixes During QA:**
- Fixed missing Skeleton component causing page render failure
- Fixed JSON.parse error: PostgreSQL JSONB columns are already parsed by pg library, removed redundant JSON.parse() call

### File List
**Backend:**
- Modified: backend/src/routes/invoices.js (added history and delete routes)
- Modified: backend/src/controllers/invoiceController.js (added getInvoiceHistory and deleteInvoiceLock)
- Created: backend/src/controllers/__tests__/invoiceController.history.test.js (comprehensive tests)

**Frontend:**
- Modified: frontend/src/types/invoice.ts (added InvoiceHistoryItem, DeleteInvoiceLockResponse)
- Modified: frontend/src/lib/api/invoices.ts (added getInvoiceHistory, deleteInvoiceLock)
- Created: frontend/src/hooks/useInvoiceHistory.ts (React Query hooks)
- Modified: frontend/src/components/InvoiceReview.tsx (completely rebuilt for history display)
- Created: frontend/src/components/ui/skeleton.tsx (Skeleton component for loading states)

## QA Results
_Not yet tested_
