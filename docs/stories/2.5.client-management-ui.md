# Story 2.5: Client Management UI

## Status
**InProgress**

## Story
**As a** user,
**I want** a screen to create, view, edit, and delete clients,
**so that** I can maintain my client database.

## Acceptance Criteria
1. Clients list page displays all clients in table/list format with company name and domain count
2. "Add Client" button opens form with fields: company_name, xero_customer_id, maintenance_contract_type, domains (dynamic list input)
3. Domain input allows adding multiple domains with add/remove buttons
4. Submitting form creates client and displays success message
5. Each client row has "Edit" and "Delete" actions
6. Edit opens pre-populated form, saving updates the client
7. Delete shows confirmation dialog before removing client, including count of contacts/tickets/time entries that will be deleted
8. Form validation displays inline error messages (e.g., "Company name required")
9. Page accessible via navigation link from dashboard/header
10. Responsive design works on mobile viewports

## Tasks / Subtasks
- [x] Task 1: Create API client service for clients (AC: 1-6)
  - [x] Create frontend/src/lib/api/clients.ts
  - [x] Implement getClients(), getClient(id), createClient(), updateClient(), deleteClient()
  - [x] Add proper TypeScript types
  - [x] Handle API errors
- [x] Task 2: Create useClients React Query hook (AC: 1-6)
  - [x] Create frontend/src/hooks/useClients.ts
  - [x] Implement useClients() for fetching list
  - [x] Implement useClient(id) for fetching single
  - [x] Implement useCreateClient() mutation
  - [x] Implement useUpdateClient() mutation
  - [x] Implement useDeleteClient() mutation
  - [x] Configure cache invalidation
- [ ] Task 3: Build client list component (AC: 1, 5, 9)
  - [ ] Create ClientList component
  - [ ] Display clients in table format
  - [ ] Show company name, contract type, domain count
  - [ ] Add Edit and Delete buttons per row
  - [ ] Add navigation to page
- [ ] Task 4: Build client form component (AC: 2, 3, 8)
  - [ ] Create ClientForm component
  - [ ] Add input fields (company name, xero ID, contract type)
  - [ ] Implement dynamic domain list input
  - [ ] Add domain add/remove buttons
  - [ ] Add form validation with react-hook-form + zod
  - [ ] Display inline validation errors
- [ ] Task 5: Implement create client flow (AC: 2, 4)
  - [ ] Add "Add Client" button to list page
  - [ ] Show ClientForm in dialog/modal
  - [ ] Submit form via useCreateClient hook
  - [ ] Show success message on creation
  - [ ] Refresh list after creation
- [ ] Task 6: Implement edit client flow (AC: 5, 6)
  - [ ] Add Edit button click handler
  - [ ] Load client data and pre-populate form
  - [ ] Submit form via useUpdateClient hook
  - [ ] Show success message on update
  - [ ] Refresh list after update
- [ ] Task 7: Implement delete client flow (AC: 5, 7)
  - [ ] Add Delete button click handler
  - [ ] Fetch deletion impact counts (contacts, tickets, time entries)
  - [ ] Show confirmation dialog with counts
  - [ ] Submit deletion via useDeleteClient hook
  - [ ] Handle locked client error (403)
  - [ ] Show success/error message
  - [ ] Refresh list after deletion
- [ ] Task 8: Add responsive styling (AC: 10)
  - [ ] Use Tailwind responsive classes
  - [ ] Test on mobile viewport
  - [ ] Ensure table scrolls horizontally if needed
  - [ ] Ensure forms are usable on mobile
- [ ] Task 9: Test complete client management flow
  - [ ] Test create client with domains
  - [ ] Test edit client and update domains
  - [ ] Test delete client (success and locked scenarios)
  - [ ] Test form validation
  - [ ] Test responsive design

## Dev Notes

### Relevant Source Tree
- `frontend/src/lib/api/clients.ts` - Client API service (created)
- `frontend/src/hooks/useClients.ts` - React Query hooks (created)
- `frontend/src/components/ClientList.tsx` - Client list component (exists, needs API integration)
- `frontend/src/components/ClientForm.tsx` - Client form component (to be created or updated)
- `frontend/src/pages/Clients.tsx` - Clients page component
- `frontend/src/components/ui/*` - shadcn/ui components (Button, Dialog, Input, Select, etc.)

### Architecture Notes
**State Management**: React Query (TanStack Query)
- Automatic caching and background refetching
- Optimistic updates for mutations
- Cache invalidation on mutations

**Form Handling**: react-hook-form + zod
- Type-safe form validation
- Integrates with shadcn/ui form components
- Clear error messages

**UI Components**: shadcn/ui (Radix UI + Tailwind)
- Accessible, customizable components
- No runtime dependency (copy-paste)
- Tailwind-based styling

### Client API Service
**Location**: `frontend/src/lib/api/clients.ts`

**Methods**:
```typescript
export const clientsApi = {
  getClients: () => Promise<Client[]>
  getClient: (id: number) => Promise<Client>
  createClient: (data: ClientRequest) => Promise<Client>
  updateClient: (id: number, data: ClientRequest) => Promise<Client>
  deleteClient: (id: number) => Promise<{ message: string, deletedCounts: {...} }>
}
```

### React Query Hooks
**Location**: `frontend/src/hooks/useClients.ts`

**Hooks**:
```typescript
useClients() // Fetch all clients
useClient(id) // Fetch single client
useCreateClient() // Create mutation
useUpdateClient() // Update mutation
useDeleteClient() // Delete mutation
```

**Cache Configuration**:
- staleTime: 5 minutes
- cacheTime: 10 minutes
- Invalidate on mutations

### Form Validation Schema
Using zod:
```typescript
const clientSchema = z.object({
  companyName: z.string().min(1, "Company name required").max(255),
  xeroCustomerId: z.string().optional(),
  maintenanceContractType: z.enum(['Hourly', 'Monthly Retainer', 'Project-Based', 'None']),
  domains: z.array(
    z.string().regex(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/, "Invalid domain format")
  ).max(50, "Max 50 domains")
});
```

### Dynamic Domain Input
**Implementation**:
- Use react-hook-form `useFieldArray` for dynamic list
- Each domain has input field + remove button
- "Add Domain" button appends new field
- Validate each domain on blur

**Example**:
```tsx
const { fields, append, remove } = useFieldArray({
  control,
  name: "domains"
});

<Button onClick={() => append("")}>Add Domain</Button>
{fields.map((field, index) => (
  <div key={field.id}>
    <Input {...register(`domains.${index}`)} />
    <Button onClick={() => remove(index)}>Remove</Button>
  </div>
))}
```

### Delete Confirmation Dialog
**Before deletion**:
1. Call API to get deletion impact counts
2. Show counts in confirmation dialog
3. User confirms or cancels
4. If confirmed, call deleteClient()

**Dialog Content**:
```
Delete Client: Acme Corp

This will permanently delete:
- 5 contacts
- 12 tickets
- 48 time entries

Are you sure you want to continue?
[Cancel] [Delete]
```

**Locked Client Error**:
```
Cannot Delete Client

This client has locked invoices for:
- August 2025
- September 2025

You cannot delete clients with locked invoices.
[Close]
```

### Testing
**Testing Strategy**: Manual testing for MVP

**Manual Testing Checklist**:
- [ ] Load clients page, see list of clients
- [ ] Click "Add Client", form opens
- [ ] Fill form with company name, contract type, domains
- [ ] Add multiple domains with "Add Domain" button
- [ ] Submit form, verify client created
- [ ] See success message
- [ ] Click Edit on client, form pre-populated
- [ ] Update client name and domains
- [ ] Submit, verify client updated
- [ ] Click Delete on client with no invoices
- [ ] See confirmation with counts
- [ ] Confirm deletion, verify client removed
- [ ] Try to delete client with locked invoices, see error
- [ ] Test validation: Submit empty form, see errors
- [ ] Test responsive: Resize to mobile, verify usability

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Story created, API service and hooks completed | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 3.5

### Debug Log References
_To be completed by dev agent_

### Completion Notes List
- API client service created in frontend/src/lib/api/clients.ts
- useClients hook created in frontend/src/hooks/useClients.ts
- UI integration pending

### File List
**Created:**
- `frontend/src/lib/api/clients.ts` - Client API service
- `frontend/src/hooks/useClients.ts` - React Query hooks

**Modified:**
- `frontend/src/components/ClientList.tsx` - Needs API integration (pending)

**To Be Created/Modified:**
- `frontend/src/components/ClientForm.tsx` - Client form component
- `frontend/src/pages/Clients.tsx` - Clients page
- Add navigation link to clients page

## QA Results
_To be completed by QA agent_
