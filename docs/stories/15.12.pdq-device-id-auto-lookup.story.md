# Story 15.12: PDQ Device ID Auto-Lookup

**Parent Epic:** [Epic 15: Asset Management Integration](../prd-asset-management.md)

## Status
Done

## Story
**As a** support technician,
**I want** the system to automatically fetch PDQ Device IDs using the device's serial number,
**so that** I can streamline asset onboarding by eliminating manual PDQ device ID lookup.

## Acceptance Criteria

1. **PDQ Device Lookup Button Added**
   - Asset form displays a "Lookup PDQ Device" button when serial number is entered
   - Button is positioned next to the PDQ Device ID field (similar to Lenovo warranty lookup pattern)
   - Button is disabled if serial number field is empty
   - Button shows loading state while API request is in progress

2. **PDQ Connect API Integration**
   - Backend service queries PDQ Connect API (`GET /v1/api/devices?filter[serialNumber]={serial}`)
   - Uses Bearer token authentication from `PDQ_API_KEY` environment variable
   - Handles successful responses by extracting device ID from response
   - Auto-populates PDQ Device ID field with returned device `id` value

3. **Error Handling and Fallback**
   - If serial number not found in PDQ (404 or empty results), display message: "Serial number not found in PDQ. Please enter manually if known."
   - If API authentication fails (401), display: "PDQ API key not configured or invalid"
   - If API is unreachable (network error/timeout), display: "Unable to connect to PDQ API. Please enter manually."
   - If API returns error, display generic error and allow manual entry
   - Manual PDQ Device ID entry remains available regardless of lookup success/failure

4. **Optional Feature Handling**
   - Lookup button and functionality are completely optional
   - Users can skip lookup and manually enter PDQ Device ID
   - Assets without PDQ enrollment can be saved without PDQ Device ID (field remains nullable)
   - Form validation does not require PDQ Device ID

5. **User Experience**
   - Lookup completes within 10 seconds or times out with user-friendly error
   - Success/error messages display below PDQ Device ID field
   - Auto-populated PDQ Device ID is editable (user can override if needed)
   - Follows same UX pattern as existing Lenovo warranty lookup button

## Tasks / Subtasks

- [x] **Task 1: Create PDQ Connect API Service** (AC: 2, 3)
  - [x] Create `/backend/src/services/pdqConnect.js` following `lenovoWarranty.js` pattern
  - [x] Implement `lookupPDQDeviceBySerial(serialNumber)` function
  - [x] Sanitize serial number input (trim whitespace, validate alphanumeric characters)
  - [x] Add Bearer token authentication using `process.env.PDQ_API_KEY`
  - [x] Query `GET /v1/api/devices?filter[serialNumber]={serial}` endpoint
  - [x] Parse response data array and extract device `id` field from first match
  - [x] Implement 10-second timeout with AbortController
  - [x] Add comprehensive error handling for 401, 404, network errors, timeouts, empty results
  - [x] Return normalized response: `{ success: boolean, pdqDeviceId: string | null, error: string | null }`
  - [x] Add logging for debugging (similar to Lenovo service)

- [x] **Task 2: Add Backend API Endpoint** (AC: 2, 3)
  - [x] Add `POST /api/assets/lookup-pdq-device` endpoint to `/backend/src/routes/assets.js`
  - [x] Require authentication middleware
  - [x] Accept `{ serial_number: string }` in request body
  - [x] Validate serial number is provided and non-empty
  - [x] Call `lookupPDQDeviceBySerial()` service
  - [x] Return success response: `{ pdq_device_id: string }` on 200
  - [x] Return error responses with appropriate HTTP codes and messages matching AC 3
  - [x] Follow existing Lenovo warranty endpoint pattern

- [x] **Task 3: Update Frontend API Client** (AC: 2)
  - [x] Add `lookupPDQDeviceBySerial(serialNumber: string)` method to `/frontend/src/lib/api/assets.ts`
  - [x] Follow pattern of existing `lookupLenovoWarrantyBySerial()` method
  - [x] Return typed response matching backend

- [x] **Task 4: Update Asset Form UI** (AC: 1, 4, 5)
  - [x] Add "Lookup PDQ Device" button next to PDQ Device ID field in `/frontend/src/components/assets/AssetForm.tsx`
  - [x] Position button similar to Lenovo warranty lookup (lines 334-364 as reference)
  - [x] Add state management: `pdqLookupLoading`, `pdqLookupError`
  - [x] Implement `handlePDQLookup()` function following `handleWarrantyLookup()` pattern
  - [x] Button disabled when serial number is empty
  - [x] Show loading spinner and "Looking up..." text during API call
  - [x] Display error messages below PDQ Device ID field on failure
  - [x] Auto-populate PDQ Device ID field on success using `setValue('pdq_device_id', result, { shouldValidate: true })`
  - [x] Ensure user can manually edit auto-populated value

- [x] **Task 5: Testing and Validation** (AC: 1-5)
  - [x] Test successful PDQ device lookup with valid serial number
  - [x] Test "not found" scenario with non-existent serial number
  - [x] Test API authentication failure (invalid/missing API key)
  - [x] Test network timeout scenario
  - [x] Test manual entry workflow (skipping lookup)
  - [x] Test form submission with and without PDQ Device ID
  - [x] Verify timeout handles gracefully at 10 seconds
  - [x] Verify user can override auto-populated PDQ Device ID
  - [x] Verify existing asset creation/edit workflows unaffected

## Dev Notes

### Existing System Integration

**Integration Point:**
- Asset form: [AssetForm.tsx:402-413](frontend/src/components/assets/AssetForm.tsx#L402-L413) (PDQ Device ID field)
- Asset API routes: [assets.js](backend/src/routes/assets.js)

**Technology Stack:**
- Backend: Node.js/Express with fetch API for HTTP requests
- Frontend: React with react-hook-form, shadcn/ui components
- API Pattern: Follow existing Lenovo Warranty API service structure

**Existing Pattern Reference:**
This story follows the exact pattern established by the Lenovo Warranty API integration (Story 15.5):
- Backend service: [lenovoWarranty.js](backend/src/services/lenovoWarranty.js)
- Frontend UI: [AssetForm.tsx:128-169](frontend/src/components/assets/AssetForm.tsx#L128-L169) (Lenovo lookup button)

**PDQ Connect API Details:**
- Base URL: `https://app.pdq.com/v1/api`
- Authentication: Bearer token (HTTP header: `Authorization: Bearer {PDQ_API_KEY}`)
- Device Query Endpoint: `GET /v1/api/devices?filter[serialNumber]={serial}`
- Response Format: JSON object with `data` array containing device objects
- Device ID field: Extract `id` from first matching device in `data` array

**Example API Response:**
```json
{
  "data": [
    {
      "id": "dvc_abc123def456",
      "hostname": "DESKTOP-ABC",
      "name": "DESKTOP-ABC.WORKGROUP",
      "serialNumber": "PF2KNMR2",
      "os": "Windows 10 Pro",
      "model": "ThinkPad P14s Gen 1",
      "manufacturer": "LENOVO",
      "architecture": "x64",
      "inserted_at": "2024-01-15T10:30:00Z"
    }
  ],
  "meta": {
    "totalCount": 1
  }
}
```

**Empty/Not Found Response:**
```json
{
  "data": [],
  "meta": {
    "totalCount": 0
  }
}
```

**Error Response Format:**
```json
{
  "errors": [
    {
      "status": 401,
      "detail": "Unauthorized"
    }
  ]
}
```

**Key Constraints:**
- PDQ API key stored in `PDQ_API_KEY` environment variable (add to `.env` file)
- PDQ API automatically routes to correct organization based on API key (no org identifier needed in URL)
- Not all assets will be enrolled in PDQ - this is an optional lookup feature
- PDQ Device ID field remains nullable in database (existing schema)
- 10-second timeout to prevent blocking user workflow
- Must gracefully handle missing API key (user may not have PDQ subscription)
- Serial number must be sanitized before API call (trim whitespace, prevent query injection)

**Response Handling:**
- Success: Extract `data[0].id` from response object
- Not Found: `data` array is empty (`data: []` with `totalCount: 0`)
- 401 Unauthorized: Invalid/missing API key (errors array with status 401)
- Network errors: Timeout or connection failure (no response)
- Rate limiting: Monitor for 429 status (not documented but may exist)

### Testing

**Test File Location:**
- Backend tests: `/backend/src/services/__tests__/pdqConnect.test.js`
- API endpoint tests: `/backend/src/routes/__tests__/assets.test.js` (add to existing file)

**Testing Standards:**
- Use Jest testing framework
- Follow existing test patterns in `lenovoWarranty.test.js` (if exists) or similar service tests
- Mock fetch API calls using jest.mock()
- Test all error scenarios comprehensively (401, 404, timeout, network errors)
- Verify proper Bearer token header formatting
- Test serial number filtering query parameter

**Testing Framework:**
- Jest for unit/integration tests
- Manual testing: Update `/docs/MANUAL_TESTING_GUIDE_15.11.md` or create new guide for Story 15.12

**Specific Testing Requirements:**
- Test with real PDQ API key if available (staging environment)
- Test graceful degradation when API key not configured
- Verify no regression in existing asset form workflows
- Confirm timeout behavior at exactly 10 seconds
- Test with various serial number formats (uppercase, lowercase, whitespace)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story creation | Sarah (PO Agent) |
| 2025-10-18 | 1.1 | Added API response examples, input sanitization, clarifications from validation | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes List
- All unit tests passing (13/13) for PDQ Connect service
- Frontend TypeScript compilation successful with no errors
- Linting passed with no new warnings introduced
- PDQ lookup button follows exact same pattern as Lenovo warranty lookup
- Error handling comprehensively covers all AC 3 scenarios
- PDQ Device ID field remains optional and editable after auto-population
- Input sanitization prevents query injection attacks
- 10-second timeout implemented with AbortController

### File List
**Created:**
- backend/src/services/pdqConnect.js
- backend/src/services/__tests__/pdqConnect.test.js

**Modified:**
- backend/src/routes/assets.js (added POST /api/assets/lookup-pdq-device endpoint)
- frontend/src/lib/api/assets.ts (added lookupPDQDeviceBySerial method and PDQDeviceInfo interface)
- frontend/src/components/assets/AssetForm.tsx (added PDQ lookup button, state management, and handlePDQLookup function)

## QA Results
_To be populated by QA agent_
