# Story 1.3: Basic Authentication System

## Status
**Done**

## Story
**As a** user,
**I want** to log in with username and password,
**so that** only I can access the ticketing system.

## Acceptance Criteria
1. User registration endpoint creates user with bcrypt-hashed password
2. Login endpoint validates credentials and creates session with HTTP-only cookie
3. Logout endpoint clears session and invalidates cookie
4. Protected API routes reject requests without valid session (401 Unauthorized)
5. Frontend login page renders with username/password form
6. Successful login redirects to dashboard (placeholder page acceptable)
7. Frontend stores authentication state and redirects unauthenticated users to login
8. Password minimum requirements enforced (8+ characters)

## Tasks / Subtasks
- [x] Task 1: Install authentication dependencies (AC: 1, 2)
  - [x] Install bcrypt for password hashing
  - [x] Install express-session for session management
  - [x] Install connect-pg-simple for PostgreSQL session store
- [x] Task 2: Create user registration endpoint (AC: 1, 8)
  - [x] Implement POST /api/auth/register
  - [x] Hash password using bcrypt (10 rounds)
  - [x] Validate email format and uniqueness
  - [x] Enforce 8+ character password requirement
  - [x] Return user object (without password hash)
- [x] Task 3: Create login endpoint (AC: 2, 8)
  - [x] Implement POST /api/auth/login
  - [x] Validate email and password
  - [x] Compare password with bcrypt hash
  - [x] Create session with HTTP-only cookie
  - [x] Return user object on success
- [x] Task 4: Create logout endpoint (AC: 3)
  - [x] Implement POST /api/auth/logout
  - [x] Destroy session server-side
  - [x] Clear session cookie
  - [x] Return success response
- [x] Task 5: Create authentication middleware (AC: 4)
  - [x] Create requireAuth middleware
  - [x] Check for valid session
  - [x] Return 401 if not authenticated
  - [x] Apply to protected routes
- [x] Task 6: Create "current user" endpoint (AC: 7)
  - [x] Implement GET /api/auth/me
  - [x] Return current authenticated user
  - [x] Return null if not authenticated
- [x] Task 7: Build frontend login page (AC: 5, 6)
  - [x] Create login page component
  - [x] Add email and password input fields
  - [x] Implement form submission
  - [x] Handle success and error states
  - [x] Redirect to dashboard on success
- [x] Task 8: Implement frontend auth state management (AC: 7)
  - [x] Create auth context or custom hook
  - [x] Check authentication status on app load
  - [x] Implement protected route wrapper
  - [x] Redirect unauthenticated users to login

## Dev Notes

### Relevant Source Tree
- `backend/src/controllers/auth.controller.js` - Authentication logic (register, login, logout)
- `backend/src/middleware/auth.middleware.js` - requireAuth middleware
- `backend/src/routes/auth.routes.js` - Auth API routes
- `backend/src/models/user.model.js` - User database operations
- `frontend/src/pages/Login.tsx` - Login page component
- `frontend/src/hooks/useAuth.ts` - Authentication hook (if implemented)
- `frontend/src/App.tsx` - Route protection logic

### Architecture Notes
**Authentication Method**: Session-based with HTTP-only cookies (not JWT)

**Session Configuration**:
```javascript
// Session stored in PostgreSQL
app.use(session({
  store: new (require('connect-pg-simple')(session))({ pool }),
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production', // HTTPS only in prod
    sameSite: 'lax',
    maxAge: 30 * 24 * 60 * 60 * 1000 // 30 days
  }
}));
```

**Password Security**:
- Hashing algorithm: bcrypt with 10 rounds
- Minimum password length: 8 characters
- Password hash never sent to frontend
- Clear error messages without exposing user existence

**Session Management**:
- Sessions stored in PostgreSQL (connect-pg-simple)
- Session lifetime: 30 days
- Session regeneration on login (prevents session fixation)
- Server-side session destruction on logout

### API Endpoints
1. `POST /api/auth/register` - Create new user
   - Body: `{ email, password, name }`
   - Returns: `{ id, email, name, createdAt }`

2. `POST /api/auth/login` - Authenticate user
   - Body: `{ email, password }`
   - Returns: `{ id, email, name }` + sets session cookie

3. `POST /api/auth/logout` - Destroy session
   - Requires: Valid session
   - Returns: `{ message: "Logged out successfully" }`

4. `GET /api/auth/me` - Get current user
   - Requires: Valid session (optional - returns null if not auth)
   - Returns: `{ id, email, name }` or `null`

### Frontend Implementation
**Login Flow**:
1. User enters email/password
2. Form submits to POST /api/auth/login
3. On success, redirect to /dashboard
4. On error, display error message

**Protected Routes**:
- Check auth status on app load (GET /api/auth/me)
- Wrap protected routes with auth check
- Redirect to /login if not authenticated

### Testing
**Testing Strategy**: Manual testing for MVP

**Backend Manual Testing Checklist**:
- [x] Register new user: `POST /api/auth/register`
- [x] Verify password is hashed in database
- [x] Login with correct credentials returns session cookie
- [x] Login with incorrect password returns 401
- [x] Login with non-existent email returns 401
- [x] Access protected route without session returns 401
- [x] Access protected route with valid session returns 200
- [x] Logout destroys session and clears cookie
- [x] Password < 8 characters rejected

**Frontend Manual Testing Checklist**:
- [x] Login page renders correctly
- [x] Form validation works (email format, password length)
- [x] Successful login redirects to dashboard
- [x] Failed login shows error message
- [x] Session persists on page refresh
- [x] Logout redirects to login page
- [x] Unauthenticated user redirected to login when accessing protected routes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Authentication system completed | Development Team |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- Session-based authentication implemented successfully (backend was complete)
- Frontend authentication was missing - implemented:
  - Login page with form validation
  - useAuth hook with React Query integration
  - ProtectedRoute component for route protection
  - Real logout functionality in Navbar
  - Removed hardcoded mock email
- bcrypt password hashing configured with 10 rounds
- PostgreSQL session store configured
- All auth endpoints created and tested
- Protected route wrapper created
- Session persistence verified
- All acceptance criteria met

### File List
**Created:**
- `backend/src/controllers/authController.js` - Register, login, logout logic
- `backend/src/middleware/auth.js` - requireAuth middleware
- `backend/src/routes/auth.js` - Auth routes
- `backend/src/models/User.js` - User database operations
- `frontend/src/pages/LoginPage.tsx` - Login page component
- `frontend/src/hooks/useAuth.ts` - Auth state management with React Query
- `frontend/src/lib/api/auth.ts` - Authentication API endpoints wrapper
- `frontend/src/components/ProtectedRoute.tsx` - Protected route wrapper component

**Modified:**
- `backend/src/index.js` - Added session middleware and auth routes
- `backend/package.json` - Added bcrypt, express-session, connect-pg-simple
- `frontend/src/App.tsx` - Added route protection logic and login route
- `frontend/src/components/Navbar.tsx` - Integrated useAuth hook, real logout, removed mock email
- `backend/.env.example` - Added SESSION_SECRET variable

## QA Results
**Status**: âœ… Passed

**Verification**:
- User registration creates hashed passwords
- Login returns session cookie
- Protected routes reject unauthenticated requests
- Frontend login flow works end-to-end
- Session persists across page refreshes
- Logout clears session successfully
- Password requirements enforced
