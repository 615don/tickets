# Story 2.2: Contact Data Model & Database Schema

## Status
**Done**

## Story
**As a** developer,
**I want** database tables and models for storing contact information,
**so that** the application can persist contacts associated with clients.

## Acceptance Criteria
1. Database migration creates `contacts` table with columns: `id`, `client_id` (foreign key), `name`, `email`, `created_at`, `updated_at`, `deleted_at` (nullable, for soft deletes)
2. Backend model/entity created for Contact with appropriate types
3. Foreign key constraint enforces `contacts.client_id` references valid client
4. Database enforces unique constraint on `email` for non-deleted contacts
5. Cascading delete configured - deleting client removes associated contacts
6. Model includes validation rules (name required, email format validation)
7. Migration runs successfully and can be rolled back

## Tasks / Subtasks
- [x] Task 1: Create contacts table migration (AC: 1, 3, 5)
  - [x] Write migration for contacts table
  - [x] Add columns: id, client_id, name, email, is_system_contact, deleted_at, created_at, updated_at
  - [x] Add foreign key constraint to clients table
  - [x] Configure ON DELETE CASCADE
  - [x] Add NOT NULL constraints where appropriate
- [x] Task 2: Implement unique email constraint (AC: 4)
  - [x] Create partial unique index on email WHERE deleted_at IS NULL
  - [x] Allows duplicate emails for soft-deleted records
  - [x] Test constraint enforcement
- [x] Task 3: Create Contact model (AC: 2, 6)
  - [x] Create Contact model in backend/src/models/contact.model.js
  - [x] Implement CRUD methods (create, findAll, findById, update, softDelete)
  - [x] Add name validation (required, max length)
  - [x] Add email format validation
- [x] Task 4: Implement soft delete functionality (AC: 1)
  - [x] Create softDelete method
  - [x] Set deleted_at timestamp instead of removing record
  - [x] Filter out deleted contacts in findAll queries
  - [x] Create system contact for ticket reassignment
- [x] Task 5: Test migrations and model (AC: 7)
  - [x] Run migrations successfully
  - [x] Test soft delete behavior
  - [x] Verify unique email constraint
  - [x] Test rollback functionality

## Dev Notes

### Relevant Source Tree
- `backend/src/utils/migrate.js` - Migration containing contacts table
- `backend/src/models/contact.model.js` - Contact data access layer

### Database Schema

**Contacts Table**:
```sql
CREATE TABLE contacts (
  id SERIAL PRIMARY KEY,
  client_id INTEGER NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  is_system_contact BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Partial unique index: email unique only for non-deleted contacts
CREATE UNIQUE INDEX idx_contacts_email_active
  ON contacts(email)
  WHERE deleted_at IS NULL;

CREATE INDEX idx_contacts_client_id ON contacts(client_id);
```

### Data Model TypeScript Interfaces
```typescript
export interface Contact {
  id: number;
  clientId: number;
  clientName?: string; // Populated via JOIN
  name: string;
  email: string;
  isSystemContact: boolean;
  deletedAt: string | null;
  createdAt: string;
  updatedAt?: string;
}

export interface ContactRequest {
  clientId: number;
  name: string;
  email: string;
}
```

### Soft Delete Pattern
**Why Soft Deletes?**
- Preserves ticket history when contacts are removed
- Allows email reuse after contact deletion
- Maintains audit trail per NFR9

**Implementation**:
- `deleted_at IS NULL` → Active contact
- `deleted_at IS NOT NULL` → Deleted contact
- Partial unique index ensures email uniqueness only for active contacts

**System Contact Creation**:
When a contact is soft-deleted:
1. Set `deleted_at` timestamp
2. Check if client has system contact
3. If not, create system contact: `deleted+{client_id}@system.local`
4. Reassign all tickets from deleted contact to system contact

### Validation Rules
**Contact**:
- `name`: Required, max 255 characters
- `email`: Required, valid email format, unique (for active contacts)
- `client_id`: Required, must reference existing client
- `is_system_contact`: Boolean, default false

**Email Validation Pattern**:
```regex
^[^\s@]+@[^\s@]+\.[^\s@]+$
```

### Architecture Notes
**Cascade Behavior**:
- Client deletion cascades to contacts (all contacts removed)
- Contact deletion does NOT cascade to tickets (handled in application logic)
- Ticket reassignment to system contact preserves referential integrity

**Relationships**:
- Many Contacts belong to one Client (many-to-one)
- One Contact has many Tickets (one-to-many)
- System Contacts are auto-created per client (one per client)

### Testing
**Testing Strategy**: Manual testing for MVP

**Manual Testing Checklist**:
- [x] Run migration: `npm run migrate`
- [x] Verify contacts table exists: `psql ticketing_system -c "\d contacts"`
- [x] Insert test contact with valid client_id
- [x] Test email unique constraint: Insert duplicate email (should fail)
- [x] Test soft delete: Delete contact, verify deleted_at set
- [x] Test email reuse: Insert new contact with same email after soft delete (should succeed)
- [x] Verify system contact creation on first deletion

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Contact data model and migrations completed | Development Team |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 3.5

### Debug Log References
N/A

### Completion Notes List
- Contacts table migration created with soft delete support
- Partial unique index on email (excludes deleted records)
- Contact model with CRUD and soft delete operations
- Email and name validation implemented
- System contact creation logic added
- Foreign key and cascade behavior configured
- All acceptance criteria met

### File List
**Created:**
- Migration in `backend/src/utils/migrate.js` for contacts table
- `backend/src/models/contact.model.js` - Contact repository

**Modified:**
- N/A

## QA Results
**Status**: ✅ Passed

**Verification**:
- Contacts table created with correct schema
- Foreign key constraint working
- Partial unique index on email enforced correctly
- Soft delete functionality working
- Email can be reused after soft delete
- Cascade delete from client working
- Model validation rules working
- System contact creation verified
