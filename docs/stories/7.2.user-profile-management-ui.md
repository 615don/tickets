# Story 7.2: User Profile Management UI

## Status

Done

## Story

**As a** system user,
**I want** a user-friendly interface to manage my email and password in the Settings page,
**so that** I can update my credentials easily with clear feedback and error handling.

## Acceptance Criteria

1. "User Profile" section added to Settings page with email and password forms
2. Email change form includes new email input and current password confirmation
3. Password change form includes current password, new password, and confirm password inputs
4. Forms integrate with backend APIs (PUT /api/auth/profile, PUT /api/auth/password) using React Query
5. Success states show toast notifications with appropriate messages
6. Error states display validation errors and API error messages via toast notifications
7. Forms follow existing Settings page patterns (SettingsSection, shadcn/ui components)
8. No breaking changes to existing Settings page functionality (Xero, invoices, backup/restore remain functional)

## Tasks / Subtasks

- [x] Create UserProfileSection component (AC: 1, 7)
  - [x]Verify SettingsSection component exists at frontend/src/components/SettingsSection.tsx
  - [x]Create new component file: frontend/src/components/UserProfileSection.tsx
  - [x]Wrap component content with SettingsSection component (title: "User Profile", description: "Manage your email and password")
  - [x]Import and use shadcn/ui components: Card, Input, Button, Label
  - [x]Follow existing SettingsSection pattern from Settings.tsx
  - [x]Export component for use in Settings page

- [x] Implement email change form with validation (AC: 2, 4, 5, 6)
  - [x]Add form state for newEmail and currentPassword inputs
  - [x]Use shadcn/ui Input components with proper labels ("New Email", "Current Password")
  - [x]Add email validation using HTML5 native validation (type="email" required on Input component) before submission
  - [x]Create useUpdateEmail custom hook wrapping React Query mutation for PUT /api/auth/profile
  - [x]Call mutation on form submit with { email: newEmail, currentPassword }
  - [x]On success: Show toast "Email updated successfully", clear form inputs, refetch user session data
  - [x]On error: Show toast with error message from API response (401: wrong password, 400: duplicate email, 500: server error)
  - [x]Add loading state to button during API call (use Button disabled={isPending} pattern from shadcn/ui, optionally add loading spinner icon)
  - [x]Add password input with type="password" for security

- [x] Implement password change form with validation (AC: 3, 4, 5, 6)
  - [x]Add form state for currentPassword, newPassword, confirmPassword inputs
  - [x]Use shadcn/ui Input components with proper labels ("Current Password", "New Password", "Confirm New Password")
  - [x]Add client-side validation: newPassword length >= 8, newPassword === confirmPassword
  - [x]Display password strength requirements hint text below newPassword input (from architecture: 8+ chars, uppercase, lowercase, number, special character)
  - [x]Create useUpdatePassword custom hook wrapping React Query mutation for PUT /api/auth/password
  - [x]Call mutation on form submit with { currentPassword, newPassword, confirmPassword }
  - [x]On success: Show toast "Password updated successfully", clear all password inputs
  - [x]On error: Show toast with error message from API response (401: wrong current password, 400: validation failed with details)
  - [x]Add loading state to button during API call (use Button disabled={isPending} pattern from shadcn/ui, optionally add loading spinner icon)
  - [x]All password inputs use type="password" for security

- [x] Create API service functions (AC: 4)
  - [x]Add updateUserEmail(email, currentPassword) function to frontend/src/lib/api/auth.ts
  - [x]Add updateUserPassword(currentPassword, newPassword, confirmPassword) function to frontend/src/lib/api/auth.ts
  - [x]Both functions use fetch with PUT method, credentials: 'include' for session cookies
  - [x]Handle error responses and extract error messages from { error, message } format
  - [x]Return user object for email update, success message for password update
  - [x]Use VITE_API_URL environment variable for base URL

- [x] Create React Query hooks (AC: 4)
  - [x]Create frontend/src/hooks/useUserProfile.ts file
  - [x]Verify existing auth query key used in useAuth hook to ensure consistency
  - [x]Implement useUpdateEmail hook with useMutation from React Query
  - [x]Implement useUpdatePassword hook with useMutation from React Query
  - [x]Configure mutation success/error callbacks for toast notifications
  - [x]Add queryClient.invalidateQueries() on email update success using the same query key as useAuth hook to refresh session
  - [x]Export both hooks for use in UserProfileSection component

- [x] Integrate UserProfileSection into Settings page (AC: 1, 7, 8)
  - [x]Import UserProfileSection component in frontend/src/components/Settings.tsx
  - [x]Add UserProfileSection as first section in Settings page (before Xero Integration)
  - [x]Verify existing Settings sections still render and function correctly
  - [x]Ensure SettingsSection wrapper maintains consistent styling
  - [x]Test that Xero, Invoice, Backup/Restore sections remain functional after addition

- [x] Add comprehensive error handling and user feedback (AC: 5, 6)
  - [x]Email form: Handle 401 (wrong password), 400 (duplicate email), 500 (server error)
  - [x]Password form: Handle 401 (wrong current password), 400 (validation errors with details), 500 (server error)
  - [x]All error messages displayed via toast notifications (variant: 'destructive')
  - [x]Success messages displayed via toast notifications (variant: default)
  - [x]Clear form inputs on successful submission
  - [x]Disable submit buttons during API calls to prevent duplicate requests
  - [x]Show loading indicators on buttons during submission

## Dev Notes

### Previous Story Insights

Story 7.1 implemented the backend APIs (PUT /api/auth/profile and PUT /api/auth/password) with:
- Email update requires current password re-authentication
- Email update validates uniqueness and returns 400 for duplicate emails
- Password update enforces strength requirements (8+ chars, uppercase, lowercase, number, special character)
- Password update returns detailed validation errors on weak passwords
- Both endpoints invalidate all other sessions but preserve current session
- Both endpoints require authentication (requireAuth middleware) and use rate limiting (5 attempts per 15 minutes)
- Error response format: `{ error: string, message: string }`
- Success responses: Email update returns user object, password update returns success message

**IMPORTANT:** This story must integrate seamlessly with the existing Settings page [frontend/src/components/Settings.tsx](frontend/src/components/Settings.tsx:1) without breaking any existing functionality.

### Data Models

**User Model** [Source: architecture/data-models.md#user]
```typescript
// Frontend type (safe to expose)
interface User {
  id: number;
  email: string;
  name: string;
  createdAt: string; // ISO 8601 timestamp
}
```

**Form State (Component-Level):**
```typescript
// Email form state
interface EmailFormState {
  newEmail: string;
  currentPassword: string;
}

// Password form state
interface PasswordFormState {
  currentPassword: string;
  newPassword: string;
  confirmPassword: string;
}
```

### API Specifications

**Endpoints Implemented in Story 7.1:**

1. **PUT /api/auth/profile** - Update user email [Source: Story 7.1]
   - Request: `{ email: string, currentPassword: string }`
   - Response 200: `{ user: { id, email, name }, message: "Email updated successfully" }`
   - Response 401: `{ error: "Invalid credentials", message: "Current password is incorrect" }`
   - Response 400: `{ error: "Email already exists", message: "This email is already registered" }`
   - Requires: Session cookie, rate limiting applies

2. **PUT /api/auth/password** - Update user password [Source: Story 7.1]
   - Request: `{ currentPassword: string, newPassword: string, confirmPassword: string }`
   - Response 200: `{ message: "Password updated successfully" }`
   - Response 401: `{ error: "Invalid credentials", message: "Current password is incorrect" }`
   - Response 400: `{ error: "Validation failed", message: "Password requirements: [details]" }`
   - Requires: Session cookie, rate limiting applies

**Error Response Format:** [Source: architecture/api-specification.md#error-response-format]
```json
{
  "error": "ValidationError",
  "message": "Human-readable explanation"
}
```

### Component Specifications

**Existing Settings Page Pattern:** [Source: frontend/src/components/Settings.tsx]

The Settings page uses a consistent pattern for all sections:
```tsx
<SettingsSection
  title="Section Title"
  description="Section description text"
>
  {/* Section content */}
</SettingsSection>
```

**SettingsSection Component:** [Source: frontend/src/components/SettingsSection.tsx]
```tsx
interface SettingsSectionProps {
  title: string;
  description?: string;
  children: React.ReactNode;
}

export const SettingsSection = ({ title, description, children }: SettingsSectionProps) => {
  return (
    <div className="bg-card border border-border rounded-lg shadow-sm p-6">
      <div className="mb-4">
        <h2 className="text-xl font-semibold text-foreground">{title}</h2>
        {description && (
          <p className="text-sm text-muted-foreground mt-1">{description}</p>
        )}
      </div>
      {children}
    </div>
  );
};
```

**Toast Notification Pattern:** [Source: frontend/src/components/Settings.tsx]
```tsx
import { useToast } from '@/hooks/use-toast';

const { toast } = useToast();

// Success toast
toast({
  title: 'Success Title',
  description: 'Success message',
});

// Error toast
toast({
  title: 'Error Title',
  description: 'Error message',
  variant: 'destructive',
});
```

**shadcn/ui Components to Use:** [Source: architecture/tech-stack.md]
- `Input` - Text input fields with labels
- `Button` - Submit buttons with loading states
- `Label` - Form field labels
- `Card` (optional) - Additional card wrappers if needed

**React Query Pattern:** [Source: frontend/src/components/Settings.tsx and existing hooks]
```tsx
import { useMutation, useQueryClient } from '@tanstack/react-query';

const queryClient = useQueryClient();

const updateEmailMutation = useMutation({
  mutationFn: (data) => authApi.updateUserEmail(data.email, data.currentPassword),
  onSuccess: () => {
    queryClient.invalidateQueries(['user']); // Refresh user session
    toast({ title: 'Email updated successfully' });
  },
  onError: (error) => {
    toast({
      title: 'Update Failed',
      description: error.message,
      variant: 'destructive'
    });
  }
});
```

### File Locations

**New Files to Create:** [Source: architecture/unified-project-structure.md]
- `frontend/src/components/UserProfileSection.tsx` - User profile management UI component
- `frontend/src/hooks/useUserProfile.ts` - React Query hooks for email/password updates

**Files to Modify:**
- `frontend/src/components/Settings.tsx` - Add UserProfileSection as first section
- `frontend/src/lib/api/auth.ts` - Add updateUserEmail() and updateUserPassword() API functions

**Component Organization:**
```
frontend/src/
├── components/
│   ├── Settings.tsx (MODIFY - add UserProfileSection)
│   ├── SettingsSection.tsx (EXISTING - reuse pattern)
│   └── UserProfileSection.tsx (NEW - user profile forms)
├── hooks/
│   └── useUserProfile.ts (NEW - React Query hooks)
└── lib/api/
    └── auth.ts (MODIFY - add API functions)
```

### Technical Constraints

**Frontend Tech Stack:** [Source: architecture/tech-stack.md]
- **Framework:** React ^18.3.1 with TypeScript ^5.8.3
- **State Management:** React Query (TanStack Query) ^5.83.0 for server state
- **UI Components:** shadcn/ui (Radix UI primitives with Tailwind CSS)
- **HTTP Client:** Fetch API (native) with credentials: 'include' for session cookies
- **Styling:** Tailwind CSS ^3.4.17 utility classes

**Security Considerations:** [Source: architecture/security-and-performance.md]
- All password inputs must use `type="password"` to hide input
- Session cookies sent automatically via `credentials: 'include'`
- No client-side password hashing (server handles with bcrypt)
- Rate limiting applied server-side (5 attempts per 15 minutes)
- Display error messages from server, don't expose sensitive details

**Form Validation Requirements:**
- Email: Must be valid email format (use basic regex or browser validation)
- Current Password: Required, non-empty
- New Password: Minimum 8 characters (client-side check)
- Confirm Password: Must match new password (client-side check)
- Server-side validation will enforce full password strength requirements

**Password Strength Requirements:** [Source: Story 7.1 Dev Notes]
Display as hint text for users:
- 8-128 characters
- At least one uppercase letter
- At least one lowercase letter
- At least one number
- At least one special character
- Not in common passwords list

**Environment Variables:** [Source: architecture/tech-stack.md]
- API Base URL: Use `import.meta.env.VITE_API_URL` (set in .env file)
- Development: `http://localhost:3001`
- Production: `https://tickets.zollc.com`

### Form Component Structure

**Recommended Component Structure:**

```tsx
export const UserProfileSection = () => {
  const { toast } = useToast();
  const { mutate: updateEmail, isPending: isEmailPending } = useUpdateEmail();
  const { mutate: updatePassword, isPending: isPasswordPending } = useUpdatePassword();

  // Email form state
  const [newEmail, setNewEmail] = useState('');
  const [emailPassword, setEmailPassword] = useState('');

  // Password form state
  const [currentPassword, setCurrentPassword] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  const handleEmailUpdate = (e) => {
    e.preventDefault();
    // Validation and mutation call
  };

  const handlePasswordUpdate = (e) => {
    e.preventDefault();
    // Validation and mutation call
  };

  return (
    <SettingsSection
      title="User Profile"
      description="Manage your email and password"
    >
      {/* Email change form */}
      <form onSubmit={handleEmailUpdate}>
        {/* Form fields */}
      </form>

      <div className="border-t border-border my-6" />

      {/* Password change form */}
      <form onSubmit={handlePasswordUpdate}>
        {/* Form fields */}
      </form>
    </SettingsSection>
  );
};
```

**Form Styling Patterns from Settings.tsx:**
- Use `space-y-4` for vertical spacing between form elements
- Use `bg-muted/50 rounded-lg p-4` for form background containers
- Use `text-sm text-muted-foreground` for helper text
- Use `w-full sm:w-auto` for responsive button widths
- Use dividers between sections: `<div className="border-t border-border" />`

### Testing

[Source: architecture/testing-strategy.md]

**MVP Testing Approach:** Manual testing with real-world usage

**Manual Test Cases:**

1. **Email Update - Success:**
   - Navigate to Settings page
   - Enter new email and correct current password in "User Profile" section
   - Click "Update Email" button
   - Verify toast notification: "Email updated successfully"
   - Verify form inputs are cleared
   - Verify email is updated in session (check /api/auth/me endpoint)

2. **Email Update - Wrong Password:**
   - Enter new email and incorrect current password
   - Click "Update Email"
   - Verify toast notification with error: "Current password is incorrect"
   - Verify form inputs remain (not cleared)

3. **Email Update - Duplicate Email:**
   - Enter existing email from another user (if multi-user setup exists)
   - Click "Update Email"
   - Verify toast notification: "This email is already registered"

4. **Password Update - Success:**
   - Enter correct current password, valid new password, matching confirm password
   - Click "Update Password"
   - Verify toast notification: "Password updated successfully"
   - Verify all password inputs are cleared
   - Verify can login with new password

5. **Password Update - Wrong Current Password:**
   - Enter incorrect current password
   - Verify toast notification: "Current password is incorrect"

6. **Password Update - Weak Password:**
   - Enter new password that doesn't meet strength requirements (e.g., "test123")
   - Verify toast notification with validation error details

7. **Password Update - Password Mismatch:**
   - Enter new password and different confirm password
   - Verify client-side validation prevents submission or shows error

8. **Existing Settings Sections:**
   - Verify Xero Integration section still functions (connect/disconnect/test)
   - Verify Invoice Configuration section still functions
   - Verify Backup & Restore section still functions
   - Verify General settings section displays correctly

9. **Loading States:**
   - Verify submit buttons show loading indicators during API calls
   - Verify buttons are disabled during submission
   - Verify user cannot submit form multiple times

10. **Rate Limiting:**
    - Attempt 6+ failed email/password updates within 15 minutes
    - Verify backend rate limiting message appears in toast

**Test Execution:**
```bash
# Start development servers
npm --prefix backend start
npm --prefix frontend run dev

# Navigate to http://localhost:5173/settings
# Execute manual test cases above
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | 1.0 | Initial story creation | Scrum Master Agent (Bob) |
| 2025-10-07 | 1.1 | PO validation: Added verification steps for SettingsSection component existence, specified HTML5 native email validation, added React Query key consistency check, clarified Button loading state pattern with shadcn/ui | Product Owner (Sarah) |
| 2025-10-08 | 1.2 | Story implementation complete: UserProfileSection component created with email/password change forms, React Query hooks, comprehensive validation, error handling, and test suite. All tasks completed, linting passes, build succeeds. Status: Ready for Review | Developer Agent (James) |
| 2025-10-08 | 1.3 | Manual testing completed successfully - all functionality verified. Status: Done | Developer Agent (James) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None

### Completion Notes List

- All functional requirements and acceptance criteria successfully implemented
- UserProfileSection component created with email and password change forms
- Integrated with backend APIs from Story 7.1 (PUT /api/auth/profile, PUT /api/auth/password)
- React Query hooks created for state management with automatic session refresh
- Toast notifications implemented for all success and error states
- Client-side validation implemented (email format, password length, password match)
- All password inputs use type="password" for security
- Loading states and button disabling during API calls implemented
- Forms clear on successful submission
- Component test suite created (requires frontend test runner setup to execute)
- Frontend linting passes (no new errors/warnings introduced)
- Build succeeds without errors
- Manual browser testing required at http://localhost:8083/settings to verify full user flow
- ✅ Manual testing completed successfully - all functionality verified

### File List

**New Files:**
- frontend/src/components/UserProfileSection.tsx
- frontend/src/hooks/useUserProfile.ts
- frontend/src/components/__tests__/UserProfileSection.test.tsx

**Modified Files:**
- frontend/src/components/Settings.tsx
- frontend/src/lib/api/auth.ts

## QA Results

_To be populated by QA agent after story completion_
