# Story 3.3: Ticket Creation API Endpoint

## Status
**Done**

## Story
**As a** developer,
**I want** an API endpoint to create tickets with minimal required fields,
**so that** the frontend can support fast ticket creation (FR1, FR2).

## Acceptance Criteria
1. `POST /api/tickets` creates new ticket with required fields: `client_id`, `contact_id`, and at least one time entry (work_date, duration, billable flag)
2. Endpoint accepts optional fields: `description`, `notes`
3. Time entry duration parsed using flexible format utility (Story 3.2)
4. Validation ensures contact belongs to specified client (400 error if mismatch)
5. New tickets default to `state: "open"`
6. Initial time entry `work_date` defaults to current date if not specified
7. Endpoint requires authentication (401 if not logged in)
8. Returns created ticket with generated ID and confirmation (201 status)
9. Request validation returns clear error messages

## Tasks / Subtasks
- [x] Task 1: Create ticket controller (AC: 1, 2, 3, 4, 5, 6, 8, 9)
  - [x] Create `backend/src/controllers/ticketController.js`
  - [x] Implement `createTicket` controller function
  - [x] Import getClient from '../config/database.js' for transaction handling
  - [x] Extract `clientId`, `contactId`, `description`, `notes`, `timeEntry` from request body
  - [x] Validate required fields (clientId, contactId, timeEntry)
  - [x] Validate contact belongs to specified client (query contacts table, check contact.clientId)
  - [x] Return 400 error if contact-client mismatch
  - [x] Import parseTimeEntry from '@tickets/shared'
  - [x] Parse timeEntry.duration using parseTimeEntry utility
  - [x] Return 400 error if duration parsing fails
  - [x] Default timeEntry.workDate to current date (YYYY-MM-DD) if not provided
  - [x] Default timeEntry.billable to true if not provided
  - [x] Wrap ticket + time entry creation in transaction (BEGIN/COMMIT/ROLLBACK)
  - [x] Call Ticket.create() to insert ticket (state defaults to 'open')
  - [x] Call TimeEntry.create() to insert initial time entry with parsed durationHours
  - [x] Commit transaction if both succeed, rollback if either fails
  - [x] Return 201 status with created ticket including ID
  - [x] Wrap in try-catch with 500 error response
- [x] Task 2: Create ticket routes (AC: 7)
  - [x] Create `backend/src/routes/tickets.js`
  - [x] Import Express router
  - [x] Import requireAuth middleware from '../middleware/auth.js'
  - [x] Import createTicket controller
  - [x] Define POST /api/tickets route with requireAuth middleware
  - [x] Export router
- [x] Task 3: Register ticket routes in main app (AC: 7)
  - [x] Import ticketRoutes in `backend/src/index.js`
  - [x] Register routes: `app.use('/api/tickets', ticketRoutes)`
  - [x] Verify route appears after session middleware setup
- [x] Task 4: Add request validation (AC: 9)
  - [x] Validate clientId is present and is integer
  - [x] Validate contactId is present and is integer
  - [x] Validate timeEntry is present and is object
  - [x] Validate timeEntry.duration is present and is string
  - [x] Return clear error messages for each validation failure
  - [x] Use consistent error format: `{ error: "ValidationError", message: "..." }`
- [x] Task 5: Test API endpoint (AC: all)
  - [x] Test successful ticket creation with minimal fields
  - [x] Test successful ticket creation with optional description/notes
  - [x] Test time entry duration parsing ("2h", "90m", "1h30m")
  - [x] Test workDate defaulting to current date
  - [x] Test billable defaulting to true
  - [x] Test contact-client validation (reject mismatched contactId)
  - [x] Test missing required fields (clientId, contactId, timeEntry.duration)
  - [x] Test invalid duration format
  - [x] Test authentication requirement (401 if not logged in)
  - [x] Verify 201 status and returned ticket includes ID

## Dev Notes

### Previous Story Context
[Source: Story 3.1 - Ticket Data Model]
- Ticket model created with `create()`, `findAll()`, `findById()`, `update()`, `deleteTicket()` methods
- TimeEntry model created with `create()`, `findByTicketId()`, `update()`, `softDelete()` methods
- Database tables already exist in migration system

[Source: Story 3.2 - Time Entry Parsing Utility]
- `parseTimeEntry` utility function available in `@tickets/shared` package
- Parses flexible formats: "2h", "90m", "1h30m" ‚Üí decimal hours
- Returns `{ success: true, hours: number }` or `{ success: false, error: string }`

### Relevant Source Tree
[Source: docs/architecture/unified-project-structure.md]
- `backend/src/controllers/ticketController.js` - **TO BE CREATED** - Ticket request handlers
- `backend/src/routes/tickets.js` - **TO BE CREATED** - Ticket route definitions
- `backend/src/models/Ticket.js` - Existing from Story 3.1
- `backend/src/models/TimeEntry.js` - Existing from Story 3.1
- `backend/src/models/Contact.js` - Existing from Story 2.2
- `backend/src/middleware/auth.js` - Existing authentication middleware
- `backend/src/index.js` - Main Express app

### API Specification
[Source: docs/architecture/api-specification.md#tickets]

**Endpoint**: `POST /api/tickets`

**Request Body**:
```json
{
  "clientId": 1,
  "contactId": 5,
  "description": "Fix login issue",
  "notes": "User reported via email",
  "timeEntry": {
    "workDate": "2025-10-01",
    "duration": "1h30m",
    "billable": true
  }
}
```

**Minimal Request** (optional fields omitted):
```json
{
  "clientId": 1,
  "contactId": 5,
  "timeEntry": {
    "duration": "2h"
  }
}
```

**Success Response** (201 Created):
```json
{
  "id": 42,
  "clientId": 1,
  "contactId": 5,
  "description": "Fix login issue",
  "notes": "User reported via email",
  "state": "open",
  "closedAt": null,
  "createdAt": "2025-10-01T14:30:00.000Z",
  "updatedAt": "2025-10-01T14:30:00.000Z"
}
```

**Error Responses**:

**400 Bad Request** - Validation error:
```json
{
  "error": "ValidationError",
  "message": "Contact does not belong to specified client"
}
```

**400 Bad Request** - Duration parsing error:
```json
{
  "error": "ValidationError",
  "message": "Invalid time format. Use formats like '2h', '90m', or '1h30m'"
}
```

**401 Unauthorized** - Not authenticated:
```json
{
  "error": "Unauthorized",
  "message": "Authentication required"
}
```

### Controller Implementation Pattern

**IMPORTANT: Transaction Handling**
Creating a ticket with initial time entry is an atomic operation requiring both database inserts to succeed. Use transactions to ensure data consistency.

**Reference Pattern** (from existing clientController.js):
[Source: backend/src/controllers/clientController.js]

```javascript
import { Ticket } from '../models/Ticket.js';
import { TimeEntry } from '../models/TimeEntry.js';
import { Contact } from '../models/Contact.js';
import { parseTimeEntry } from '@tickets/shared';
import { getClient } from '../config/database.js';

// POST /api/tickets - Create new ticket with initial time entry
export const createTicket = async (req, res) => {
  try {
    const { clientId, contactId, description, notes, timeEntry } = req.body;

    // Validate required fields
    if (!clientId) {
      return res.status(400).json({
        error: 'ValidationError',
        message: 'clientId is required'
      });
    }

    if (!contactId) {
      return res.status(400).json({
        error: 'ValidationError',
        message: 'contactId is required'
      });
    }

    if (!timeEntry || !timeEntry.duration) {
      return res.status(400).json({
        error: 'ValidationError',
        message: 'timeEntry with duration is required'
      });
    }

    // Validate contact belongs to client
    const contact = await Contact.findById(contactId);
    if (!contact) {
      return res.status(404).json({
        error: 'NotFound',
        message: 'Contact not found'
      });
    }

    if (contact.clientId !== clientId) {
      return res.status(400).json({
        error: 'ValidationError',
        message: 'Contact does not belong to specified client'
      });
    }

    // Parse time entry duration
    const parseResult = parseTimeEntry(timeEntry.duration);
    if (!parseResult.success) {
      return res.status(400).json({
        error: 'ValidationError',
        message: parseResult.error
      });
    }

    // Use transaction to ensure atomic ticket + time entry creation
    const dbClient = await getClient();

    try {
      await dbClient.query('BEGIN');

      // Create ticket
      const ticket = await Ticket.create({
        clientId,
        contactId,
        description: description || null,
        notes: notes || null,
        state: 'open'
      });

      // Create initial time entry
      const workDate = timeEntry.workDate || new Date().toISOString().split('T')[0]; // YYYY-MM-DD
      const billable = timeEntry.billable !== undefined ? timeEntry.billable : true;

      await TimeEntry.create({
        ticketId: ticket.id,
        workDate,
        durationHours: parseResult.hours,
        billable
      });

      await dbClient.query('COMMIT');

      // Return created ticket
      res.status(201).json(ticket);

    } catch (dbError) {
      await dbClient.query('ROLLBACK');
      throw dbError;
    } finally {
      dbClient.release();
    }

  } catch (error) {
    console.error('Create ticket error:', error);
    res.status(500).json({
      error: 'InternalServerError',
      message: error.message
    });
  }
};
```

### Route Implementation Pattern

**Reference Pattern** (from existing routes/clients.js):
[Source: backend/src/routes/clients.js]

```javascript
import express from 'express';
import { requireAuth } from '../middleware/auth.js';
import { createTicket } from '../controllers/ticketController.js';

const router = express.Router();

// All ticket routes require authentication
router.post('/', requireAuth, createTicket);

export default router;
```

### Main App Registration

**Pattern** (from backend/src/index.js):
```javascript
import ticketRoutes from './routes/tickets.js';

// ... after session middleware setup ...

app.use('/api/tickets', ticketRoutes);
```

### Validation Details

**Contact-Client Relationship Validation**:
[Source: Story 2.2 - Contact Data Model]
- Query contacts table using Contact.findById(contactId)
- Compare `contact.clientId` with request `clientId` (models return camelCase per Story 3.1)
- Return 400 error if mismatch or contact not found (404)

**Time Entry Duration Parsing**:
[Source: Story 3.2 - parseTimeEntry utility]
- Import: `import { parseTimeEntry } from '@tickets/shared'`
- Usage: `const result = parseTimeEntry(timeEntry.duration)`
- Success: `result.success === true`, use `result.hours`
- Failure: `result.success === false`, return `result.error` message

**Work Date Defaulting**:
- If `timeEntry.workDate` not provided, use current date
- Format: YYYY-MM-DD (ISO date string)
- JavaScript: `new Date().toISOString().split('T')[0]`

**Billable Flag Defaulting**:
- If `timeEntry.billable` not provided, default to `true`
- JavaScript: `const billable = timeEntry.billable !== undefined ? timeEntry.billable : true`

### Data Model References
[Source: docs/architecture/data-models.md#ticket]

**Ticket Model** (Story 3.1):
```javascript
Ticket.create({ clientId, contactId, description, notes, state })
// Returns: { id, clientId, contactId, description, notes, state, closedAt, createdAt, updatedAt }
```

**TimeEntry Model** (Story 3.1):
```javascript
TimeEntry.create({ ticketId, workDate, durationHours, billable })
// Returns: { id, ticketId, workDate, durationHours, billable, deletedAt, createdAt, updatedAt }
```

**Contact Model** (Story 2.2):
```javascript
Contact.findById(contactId)
// Returns: { id, clientId, name, email, isSystemContact, deletedAt, createdAt, updatedAt }
// Note: Models return camelCase properties (per Story 3.1 convention)
```

### Error Handling Standards
[Source: docs/architecture/api-specification.md#error-response-format]

**Consistent Error Format**:
```json
{
  "error": "ErrorType",
  "message": "Human-readable explanation"
}
```

**HTTP Status Codes**:
- `200 OK` - Success (GET, PUT, DELETE)
- `201 Created` - Resource created (POST)
- `400 Bad Request` - Validation error
- `401 Unauthorized` - Authentication required
- `404 Not Found` - Resource does not exist
- `500 Internal Server Error` - Unexpected server error

### Testing

**Testing Strategy**: Manual testing for MVP
[Source: docs/architecture/testing-strategy.md]

**Manual Testing Checklist**:
- [ ] Create ticket with all fields - verify 201 response with ticket ID
- [ ] Create ticket with minimal fields (only clientId, contactId, duration) - verify defaults applied
- [ ] Parse "2h" duration - verify timeEntry created with 2.0 hours
- [ ] Parse "90m" duration - verify timeEntry created with 1.5 hours
- [ ] Parse "1h30m" duration - verify timeEntry created with 1.5 hours
- [ ] Omit workDate - verify defaults to current date (YYYY-MM-DD)
- [ ] Omit billable - verify defaults to true
- [ ] Provide workDate "2025-09-15" - verify stored correctly
- [ ] Provide billable false - verify stored as false
- [ ] Provide invalid duration "abc" - verify 400 error with parseTimeEntry error message
- [ ] Provide contactId from different client - verify 400 error "Contact does not belong to specified client"
- [ ] Provide non-existent contactId - verify 404 error "Contact not found"
- [ ] Omit clientId - verify 400 error "clientId is required"
- [ ] Omit contactId - verify 400 error "contactId is required"
- [ ] Omit timeEntry.duration - verify 400 error "timeEntry with duration is required"
- [ ] Send request without authentication - verify 401 error
- [ ] Query database - verify ticket and time_entry records created
- [ ] Verify ticket state = 'open' by default
- [ ] Verify ticket closedAt = null for new tickets

**Test with cURL**:
```bash
# Successful ticket creation
curl -X POST http://localhost:3001/api/tickets \
  -H "Content-Type: application/json" \
  -H "Cookie: connect.sid=<session_cookie>" \
  -d '{
    "clientId": 1,
    "contactId": 5,
    "description": "Fix login bug",
    "timeEntry": {
      "duration": "2h"
    }
  }'

# Expected: 201 with ticket object including id
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-01 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-10-01 | 1.1 | Applied validation fixes: corrected contact.clientId property name, added transaction handling for atomic ticket creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes List
- Successfully created POST /api/tickets endpoint with requireAuth middleware
- Implemented atomic ticket + time entry creation using PostgreSQL transactions
- Integrated parseTimeEntry utility from Story 3.2 for flexible duration formats
- Added comprehensive request validation (required fields, contact-client relationship, duration parsing)
- Tested all acceptance criteria with test script - 3 tickets successfully created in database
- **IMPORTANT**: Contact model returns snake_case (client_id) while Ticket/TimeEntry use camelCase (clientId)
  - Added compatibility check in controller: `contact.clientId || contact.client_id`
  - Future consideration: Standardize all models to camelCase for consistency
- All validation scenarios tested: invalid duration, contact-client mismatch, missing fields
- Transaction rollback verified to work correctly on errors

### File List
- `backend/src/controllers/ticketController.js` - Created: Ticket creation controller with validation and transactions
- `backend/src/routes/tickets.js` - Created: Ticket routes with authentication
- `backend/src/index.js` - Modified: Registered ticket routes

## QA Results

### Review Date: 2025-10-01

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The ticket creation API endpoint is **functionally complete** and implements all acceptance criteria. The implementation demonstrates solid understanding of transaction management, validation patterns, and error handling. The code is well-structured and follows the established patterns from previous stories.

**Strengths:**
- ‚úÖ Proper transaction handling ensures atomic ticket + time entry creation
- ‚úÖ Comprehensive input validation with clear error messages
- ‚úÖ Authentication properly enforced via requireAuth middleware
- ‚úÖ Contact-client relationship validation prevents data integrity issues
- ‚úÖ Proper use of database transactions with COMMIT/ROLLBACK
- ‚úÖ Integration with parseTimeEntry utility from Story 3.2

**Issues Found and Addressed:**
- üîß **FIXED**: Redundant duration parsing - controller was parsing duration but TimeEntry.create() also parses it
- üîß **FIXED**: Unused import of parseTimeEntry in controller

### Refactoring Performed

- **File**: [backend/src/controllers/ticketController.js](backend/src/controllers/ticketController.js)
  - **Change**: Removed redundant parseTimeEntry import and pre-validation
  - **Why**: TimeEntry.create() already handles duration parsing and validation internally, making controller-level parsing unnecessary and duplicative
  - **How**: Removed duplicate validation logic, allowing TimeEntry model to handle parsing consistently

### Compliance Check

- Coding Standards: ‚úì Follows established patterns, error format, and naming conventions
- Project Structure: ‚úì Files created in correct locations per unified-project-structure.md
- Testing Strategy: ‚úó **Manual testing only** - no automated tests (see recommendations)
- All ACs Met: ‚úì All 9 acceptance criteria validated via manual testing

### Requirements Traceability (Given-When-Then)

**AC1: POST /api/tickets creates ticket with required fields**
- **Given** authenticated user with clientId=1, contactId=5, timeEntry.duration="2h"
- **When** POST /api/tickets is called
- **Then** new ticket is created with 201 status and initial time entry
- **Coverage**: ‚úì Validated via manual testing (Dev Completion Notes)

**AC2: Endpoint accepts optional fields**
- **Given** request includes optional description and notes
- **When** POST /api/tickets is called
- **Then** ticket is created with description and notes stored
- **Coverage**: ‚úì Validated via manual testing

**AC3: Time entry duration parsed using flexible format utility**
- **Given** timeEntry.duration="1h30m", "2h", or "90m"
- **When** ticket is created
- **Then** duration is parsed correctly via parseTimeEntry from Story 3.2
- **Coverage**: ‚úì TimeEntry.create() calls parseTimeEntry utility

**AC4: Validation ensures contact belongs to client**
- **Given** contactId does not belong to specified clientId
- **When** POST /api/tickets is called
- **Then** 400 error with "Contact does not belong to specified client"
- **Coverage**: ‚úì Lines 43-49 validate contact.client_id matches clientId

**AC5: New tickets default to state: "open"**
- **Given** no state specified in request
- **When** ticket is created
- **Then** ticket.state defaults to 'open'
- **Coverage**: ‚úì Line 64 explicitly sets state: 'open'

**AC6: Initial time entry work_date defaults to current date**
- **Given** timeEntry.workDate not provided
- **When** ticket is created
- **Then** workDate defaults to current date in YYYY-MM-DD format
- **Coverage**: ‚úì Line 68 implements default: `new Date().toISOString().split('T')[0]`

**AC7: Endpoint requires authentication**
- **Given** unauthenticated request
- **When** POST /api/tickets is called
- **Then** 401 error returned
- **Coverage**: ‚úì requireAuth middleware in routes/tickets.js:8

**AC8: Returns created ticket with ID and 201 status**
- **Given** valid request
- **When** ticket is created successfully
- **Then** 201 status with ticket object including generated ID
- **Coverage**: ‚úì Line 80 returns res.status(201).json(ticket)

**AC9: Request validation returns clear error messages**
- **Given** missing clientId, contactId, or timeEntry.duration
- **When** POST /api/tickets is called
- **Then** 400 error with specific validation message
- **Coverage**: ‚úì Lines 13-32 validate all required fields with clear messages

### Improvements Checklist

- [x] Refactored redundant duration parsing (ticketController.js)
- [x] Removed unused parseTimeEntry import
- [ ] Add automated integration tests for POST /api/tickets endpoint
- [ ] Consider standardizing Contact model to return camelCase (matches Ticket/TimeEntry models)
- [ ] Consider extracting validation logic to reusable middleware

### Security Review

**Status: PASS ‚úì**

- ‚úÖ Authentication enforced via requireAuth middleware
- ‚úÖ Input validation prevents injection attacks
- ‚úÖ No sensitive data exposed in error messages
- ‚úÖ Transaction rollback prevents partial data states
- ‚úÖ Parameterized queries used in all database operations (models)

### Performance Considerations

**Status: PASS ‚úì**

- ‚úÖ Single database transaction for atomic operation
- ‚úÖ Minimal round trips to database
- ‚úÖ Appropriate indexing assumed on foreign keys (client_id, contact_id)
- ‚ö†Ô∏è Consider adding database index on tickets.state for filtering queries

### Technical Debt Identified

1. **Model Inconsistency (Medium Priority)**
   - Contact model returns snake_case (`client_id`) while Ticket/TimeEntry return camelCase (`clientId`)
   - Workaround added in controller (line 44): `contact.clientId || contact.client_id`
   - Recommendation: Standardize all models to camelCase for consistency
   - Tracked in: Dev Completion Notes

2. **Missing Automated Tests (High Priority)**
   - No integration tests for ticket creation endpoint
   - Only manual testing performed
   - Risk: Regressions may go undetected in future changes
   - Recommendation: Add automated tests before next epic

### Files Modified During Review

- [backend/src/controllers/ticketController.js](backend/src/controllers/ticketController.js) - Removed redundant duration parsing logic

**Note to Dev:** Please add this file to the File List in Dev Agent Record section.

### Gate Status

Gate: **CONCERNS** ‚Üí [docs/qa/gates/3.3-ticket-creation-api.yml](docs/qa/gates/3.3-ticket-creation-api.yml)

**Gate Criteria Met:**
- ‚úÖ All 9 acceptance criteria implemented and validated
- ‚úÖ Security requirements met
- ‚úÖ Performance acceptable
- ‚ö†Ô∏è No automated tests (manual testing only)
- ‚ö†Ô∏è Model inconsistency creates maintainability concern

**Status Reason:** Implementation is functionally complete with good code quality, but lacks automated tests and has a model consistency issue. These are non-blocking for MVP but should be addressed.

### Recommended Status

**‚úì Ready for Done** (with recommendations for future improvement)

Story owner decides final status. Code is production-ready but consider addressing:
1. Add integration tests in next sprint
2. Standardize Contact model to camelCase in technical debt backlog
