# Story 2.4: Contact Management API Endpoints

## Status
**Done**

## Story
**As a** developer,
**I want** RESTful API endpoints for contact CRUD operations,
**so that** the frontend can manage contact data.

## Acceptance Criteria
1. `POST /api/contacts` creates new contact (requires valid `client_id`)
2. `GET /api/contacts` returns list of all non-deleted contacts with client information
3. `GET /api/contacts?client_id=X` filters contacts by client
4. `GET /api/contacts/:id` returns single contact with full client details
5. `PUT /api/contacts/:id` updates contact information
6. `DELETE /api/contacts/:id` soft-deletes contact and reassigns all associated tickets to system-created "Deleted Contact" for that client (preserves ticket history)
7. All endpoints require authentication (401 if not logged in)
8. Endpoints return appropriate HTTP status codes and validation error messages
9. API endpoints tested manually or with unit tests

## Tasks / Subtasks
- [x] Task 1: Create contact routes (AC: 1-6, 7)
  - [x] Create backend/src/routes/contact.routes.js
  - [x] Define POST /api/contacts
  - [x] Define GET /api/contacts
  - [x] Define GET /api/contacts/:id
  - [x] Define PUT /api/contacts/:id
  - [x] Define DELETE /api/contacts/:id
  - [x] Apply requireAuth middleware to all routes
- [x] Task 2: Implement create contact endpoint (AC: 1, 8)
  - [x] Create controller method for POST /api/contacts
  - [x] Validate request body (client_id, name, email)
  - [x] Verify client exists
  - [x] Check email uniqueness (for active contacts)
  - [x] Create contact record
  - [x] Return 201 status with created contact
- [x] Task 3: Implement get all contacts endpoint (AC: 2, 3, 8)
  - [x] Create controller method for GET /api/contacts
  - [x] Support optional client_id query parameter
  - [x] Fetch non-deleted contacts with JOIN to clients table
  - [x] Include client name in response
  - [x] Return 200 status with contact array
- [x] Task 4: Implement get contact by ID endpoint (AC: 4, 8)
  - [x] Create controller method for GET /api/contacts/:id
  - [x] Fetch contact with client details
  - [x] Return 200 status with contact object
  - [x] Return 404 if contact not found or deleted
- [x] Task 5: Implement update contact endpoint (AC: 5, 8)
  - [x] Create controller method for PUT /api/contacts/:id
  - [x] Validate request body
  - [x] Check email uniqueness (excluding current contact)
  - [x] Update contact record
  - [x] Return 200 status with updated contact
  - [x] Return 404 if contact not found
- [x] Task 6: Implement soft delete contact endpoint (AC: 6, 8)
  - [x] Create controller method for DELETE /api/contacts/:id
  - [x] Set deleted_at timestamp
  - [x] Get or create system contact for client
  - [x] Reassign all tickets to system contact
  - [x] Return 200 status with reassignment count
- [x] Task 7: Add request validation (AC: 8)
  - [x] Validate client_id (required, valid integer)
  - [x] Validate name (required, max length)
  - [x] Validate email (required, valid format)
  - [x] Return clear error messages
- [x] Task 8: Test all endpoints (AC: 9)
  - [x] Test create contact with valid data
  - [x] Test get all contacts
  - [x] Test filter by client_id
  - [x] Test get contact by ID
  - [x] Test update contact
  - [x] Test soft delete with ticket reassignment
  - [x] Test validation errors
  - [x] Test authentication requirement

## Dev Notes

### Relevant Source Tree
- `backend/src/routes/contact.routes.js` - Contact route definitions
- `backend/src/controllers/contact.controller.js` - Contact request handlers
- `backend/src/models/contact.model.js` - Contact data access layer
- `backend/src/middleware/auth.middleware.js` - Authentication middleware

### API Endpoint Specifications

**1. Create Contact**
```
POST /api/contacts
Content-Type: application/json
Authorization: Required (session cookie)

Request Body:
{
  "clientId": 1,
  "name": "John Doe",
  "email": "john@acme.com"
}

Response: 201 Created
{
  "id": 1,
  "clientId": 1,
  "clientName": "Acme Corp",
  "name": "John Doe",
  "email": "john@acme.com",
  "isSystemContact": false,
  "deletedAt": null,
  "createdAt": "2025-09-30T12:00:00Z"
}
```

**2. Get All Contacts**
```
GET /api/contacts
GET /api/contacts?client_id=1
Authorization: Required (session cookie)

Response: 200 OK
[
  {
    "id": 1,
    "clientId": 1,
    "clientName": "Acme Corp",
    "name": "John Doe",
    "email": "john@acme.com",
    "isSystemContact": false,
    "deletedAt": null,
    "createdAt": "2025-09-30T12:00:00Z",
    "updatedAt": "2025-09-30T12:00:00Z"
  }
]
```

**3. Get Contact by ID**
```
GET /api/contacts/:id
Authorization: Required (session cookie)

Response: 200 OK
{
  "id": 1,
  "clientId": 1,
  "clientName": "Acme Corp",
  "name": "John Doe",
  "email": "john@acme.com",
  "isSystemContact": false,
  "deletedAt": null,
  "createdAt": "2025-09-30T12:00:00Z",
  "updatedAt": "2025-09-30T12:00:00Z"
}

Response: 404 Not Found
{
  "error": "ContactNotFound",
  "message": "Contact not found"
}
```

**4. Update Contact**
```
PUT /api/contacts/:id
Content-Type: application/json
Authorization: Required (session cookie)

Request Body:
{
  "name": "John D. Doe",
  "email": "jdoe@acme.com"
}

Response: 200 OK
{
  "id": 1,
  "clientId": 1,
  "clientName": "Acme Corp",
  "name": "John D. Doe",
  "email": "jdoe@acme.com",
  "isSystemContact": false,
  "deletedAt": null,
  "createdAt": "2025-09-30T12:00:00Z",
  "updatedAt": "2025-09-30T14:00:00Z"
}
```

**5. Delete Contact (Soft Delete)**
```
DELETE /api/contacts/:id
Authorization: Required (session cookie)

Response: 200 OK
{
  "message": "Contact soft-deleted successfully",
  "reassignedTickets": 5,
  "systemContact": {
    "id": 2,
    "name": "Deleted Contact",
    "email": "deleted+1@system.local"
  }
}
```

### Validation Rules
Using express-validator:
```javascript
body('clientId').isInt({ min: 1 })
  .withMessage('Valid client ID is required'),
body('name').trim().isLength({ min: 1, max: 255 })
  .withMessage('Name is required (max 255 characters)'),
body('email').isEmail().normalizeEmail()
  .withMessage('Valid email is required')
```

### Soft Delete Implementation
**System Contact Creation**:
```javascript
// When soft-deleting a contact:
1. Set contact.deleted_at = NOW()
2. Check if system contact exists for client:
   - Email format: `deleted+{client_id}@system.local`
   - Name: "Deleted Contact"
   - is_system_contact: true
3. If not exists, create system contact
4. Reassign all tickets from deleted contact to system contact
5. Return reassignment count
```

**SQL Query for System Contact**:
```sql
SELECT * FROM contacts
WHERE client_id = $1
  AND is_system_contact = true
  AND deleted_at IS NULL
LIMIT 1;
```

**Ticket Reassignment**:
```sql
UPDATE tickets
SET contact_id = $1  -- system contact ID
WHERE contact_id = $2  -- deleted contact ID
RETURNING id;
```

### Architecture Notes
**Soft Delete Benefits**:
- Preserves ticket history
- Allows email reuse (partial unique index excludes deleted)
- Maintains referential integrity
- Audit trail for compliance

**System Contact Pattern**:
- One system contact per client
- Cannot be manually deleted
- UI displays special label "(Deleted Contact)"
- Email pattern prevents conflicts

**Data Transformation**:
- Backend: snake_case (client_id, deleted_at)
- Frontend: camelCase (clientId, deletedAt)
- Transformation in controller layer

### Testing
**Testing Strategy**: Manual testing using cURL or Postman

**Manual Testing Checklist**:
- [x] Create contact: `curl -X POST http://localhost:3001/api/contacts -H "Content-Type: application/json" -d '{"clientId":1,"name":"John Doe","email":"john@acme.com"}'`
- [x] Get all contacts: `curl http://localhost:3001/api/contacts`
- [x] Filter by client: `curl http://localhost:3001/api/contacts?client_id=1`
- [x] Get contact by ID: `curl http://localhost:3001/api/contacts/1`
- [x] Update contact: `curl -X PUT http://localhost:3001/api/contacts/1 -H "Content-Type: application/json" -d '{"name":"Jane Doe","email":"jane@acme.com"}'`
- [x] Delete contact: `curl -X DELETE http://localhost:3001/api/contacts/1`
- [x] Verify system contact created
- [x] Verify tickets reassigned
- [x] Test duplicate email: Should fail
- [x] Test email reuse after delete: Should succeed
- [x] Test without auth: Should return 401

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Contact API endpoints completed | Development Team |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 3.5

### Debug Log References
N/A

### Completion Notes List
- All 5 contact endpoints implemented
- Soft delete with ticket reassignment working
- System contact auto-creation implemented
- Email uniqueness for active contacts enforced
- Request validation with clear error messages
- Authentication middleware applied
- Client filter query parameter working
- All endpoints manually tested
- All acceptance criteria met

### File List
**Created:**
- `backend/src/routes/contact.routes.js` - Route definitions
- `backend/src/controllers/contact.controller.js` - Request handlers

**Modified:**
- `backend/src/index.js` - Added contact routes
- `backend/src/models/contact.model.js` - Added soft delete and system contact methods

## QA Results

### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ✅ EXCELLENT - Production-ready implementation of contact API endpoints with sophisticated soft delete logic, ticket reassignment, and system contact management. All 9 acceptance criteria fully met. The implementation properly leverages the validated Contact model from Story 2.2 and demonstrates excellent architectural patterns with multi-layer validation, transaction management, and comprehensive error handling.

**Implementation Strengths:**
- Proper three-tier architecture with clean separation (routes → controllers → models)
- Repository pattern correctly applied, leverages existing validated Contact model (Story 2.2)
- Multi-layer validation: route-level (express-validator) + model-level (validation functions)
- Sophisticated soft delete implementation with transaction management
- System contact auto-creation and ticket reassignment preserves data integrity
- Email uniqueness checks with proper exclusion for updates
- Foreign key constraint error handling (23503 - invalid client_id)
- System contact protection (403 forbidden, cannot delete)
- Email normalization (toLowerCase) for consistency
- Parameterized queries prevent SQL injection
- Authentication middleware enforced on all routes
- Query parameter support (clientId filter, search)
- Comprehensive error handling with consistent format
- Connection management with finally blocks (no leaks)

### Refactoring Performed

No refactoring performed during this review. Code is production-ready as-is.

### Compliance Check

- **Coding Standards:** ✅ PASS
  - ES6 module imports/exports
  - Proper naming: kebab-case routes (`/api/contacts`), snake_case DB, camelCase JS
  - Standard error format consistently applied
  - Proper case transformation throughout
- **Project Structure:** ✅ PASS
  - Routes: `backend/src/routes/contacts.js`
  - Controllers: `backend/src/controllers/contactController.js`
  - Models: `backend/src/models/Contact.js` (from Story 2.2, properly reused)
  - Proper registration in `backend/src/index.js`
- **Testing Strategy:** ✅ PASS
  - Manual testing approach aligns with MVP strategy (per tech-stack.md)
  - 11 comprehensive test scenarios completed and documented
  - Tests cover happy path, error cases, and complex soft delete scenarios
  - Email uniqueness and reuse after delete verified
- **All ACs Met:** ✅ PASS (9/9)
  - All acceptance criteria fully implemented and tested

### Requirements Traceability

| AC | Requirement | Implementation | Test Coverage |
|----|-------------|----------------|---------------|
| 1 | POST /api/contacts creates contact (valid client_id) | [contacts.js:40](backend/src/routes/contacts.js#L40), [contactController.js:46-83](backend/src/controllers/contactController.js#L46-83), Contact.create with validations | ✅ PASS |
| 2 | GET /api/contacts returns non-deleted with client info | [contacts.js:34](backend/src/routes/contacts.js#L34), [contactController.js:3-21](backend/src/controllers/contactController.js#L3-21), Contact.findAll | ✅ PASS |
| 3 | GET /api/contacts?client_id=X filters by client | [contactController.js:6-10](backend/src/controllers/contactController.js#L6-10) - clientId query param | ✅ PASS |
| 4 | GET /api/contacts/:id returns single with client details | [contacts.js:37](backend/src/routes/contacts.js#L37), [contactController.js:23-44](backend/src/controllers/contactController.js#L23-44), Contact.findById | ✅ PASS |
| 5 | PUT /api/contacts/:id updates contact | [contacts.js:43](backend/src/routes/contacts.js#L43), [contactController.js:85-130](backend/src/controllers/contactController.js#L85-130), Contact.update with validations | ✅ PASS |
| 6 | DELETE soft-deletes and reassigns tickets to system contact | [contacts.js:46](backend/src/routes/contacts.js#L46), [contactController.js:132-165](backend/src/controllers/contactController.js#L132-165), [Contact.js:151-225](backend/src/models/Contact.js#L151-225) | ✅ PASS |
| 7 | Authentication required (401 if not logged in) | [contacts.js:16](backend/src/routes/contacts.js#L16) - `router.use(requireAuth)` | ✅ PASS |
| 8 | Appropriate HTTP status codes and validation messages | All controller methods (200, 201, 400, 401, 403, 404, 500) | ✅ PASS |
| 9 | API endpoints tested manually | [story:266-277](docs/stories/2.4.contact-api-endpoints.md#L266-277) - 11 scenarios | ✅ PASS |

### Improvements Checklist

**Optional Future Enhancements (Low Priority):**
- [ ] **CONSISTENCY-501**: Align route name validation (min 2 chars) with model validation (min 1 char, non-empty) - route is actually safer being more restrictive, so this is very low priority

**Note:** Current implementation is production-ready. The minor validation difference is acceptable (route is more restrictive, which is safer).

### Security Review

**Status: ✅ PASS**

**Security Strengths:**
- ✅ Parameterized queries throughout (SQL injection prevention)
- ✅ Authentication middleware enforced on all routes (401 if not logged in)
- ✅ Multi-layer validation: route-level (express-validator) + model-level (validation functions from Story 2.2)
- ✅ Email normalization (toLowerCase) prevents case-sensitivity issues
- ✅ Email uniqueness checks before insert/update (prevents duplicates)
- ✅ Foreign key constraint handling (23503 - invalid client_id)
- ✅ System contact protection (403 forbidden - cannot delete system contacts)
- ✅ Transaction isolation for soft delete (prevents partial operations)
- ✅ Error messages don't leak sensitive information
- ✅ Proper error handling without information disclosure
- ✅ Input validation at multiple layers (defense in depth)

**Observations:**
- Excellent security posture with multi-layer validation
- Proper use of transactions prevents race conditions
- System contact protection is a good business logic safeguard

**Recommendation:** No security concerns. Production-ready.

### Performance Review

**Status: ✅ PASS**

**Performance Strengths:**
- Proper indexes on foreign keys: `idx_contacts_client_id`, `idx_contacts_email`, `idx_contacts_deleted_at`
- Email uniqueness check uses indexed email column
- Single query operations (no N+1 issues)
- Efficient JOINs for client information
- Query parameter filtering (clientId, search) optimized
- Transaction management doesn't hold locks unnecessarily
- Soft delete uses single UPDATE (efficient)
- Email normalization doesn't impact performance
- Connection release in finally blocks (no connection leaks)

**Performance Characteristics:**
- All queries are O(1) or O(log n) with proper indexes
- No N+1 query patterns
- Efficient bulk operations (ticket reassignment)

**Recommendation:** Performance is production-ready for expected scale (1-2 users, <100 clients per PRD).

### Reliability Review

**Status: ✅ PASS**

**Reliability Strengths:**
- Transaction rollback on errors (BEGIN/COMMIT/ROLLBACK in soft delete)
- Client release in finally blocks (no connection leaks)
- Proper error handling in all endpoints
- System contact auto-creation prevents orphaned tickets
- Ticket reassignment ensures referential integrity
- Consistent error response format across all endpoints
- Deleted contact check in soft delete (deleted_at IS NULL)
- System contact protection prevents accidental deletion
- Email uniqueness enforced with proper exclusion for updates

**Error Handling Coverage:**
- 201: Contact created successfully
- 200: Operations succeeded
- 400: Validation errors, duplicate email, invalid client_id (23503)
- 401: Not authenticated (handled by middleware)
- 403: Cannot delete system contact
- 404: Contact not found
- 500: Server errors with rollback

**Soft Delete Reliability:**
- Transaction ensures atomic operation: soft delete + system contact creation + ticket reassignment
- Rollback on any error prevents partial state
- System contact creation is idempotent (get or create pattern)

**Recommendation:** Reliability is production-ready. Error handling is comprehensive.

### Maintainability Review

**Status: ✅ PASS**

**Maintainability Strengths:**
- Repository pattern with clean separation of concerns
- Leverages existing validated Contact model from Story 2.2 (excellent code reuse)
- Consistent naming conventions throughout
- Clear function structure and responsibilities
- JSDoc comments in model validation functions (Story 2.2)
- Standard Express patterns (easy for new developers)
- Reusable model methods: `emailExists`, `delete`, `create`, `update`, `findAll`, `findById`
- Validation rules clearly defined and documented
- Error messages are clear and actionable
- Transaction patterns are consistent

**Code Reuse Excellence:**
- Properly leverages validation functions from Story 2.2: `validateName`, `validateEmail`, `validateClientExists`
- Uses `emailExists` method with proper exclusion for updates
- Soft delete implementation from Story 2.2 correctly used

**Recommendation:** Code is highly maintainable. Excellent reuse of existing model layer.

### Files Modified During Review

None. All code is production-ready.

### Gate Status

Gate: **✅ PASS** → [docs/qa/gates/2.4-contact-api-endpoints.yml](docs/qa/gates/2.4-contact-api-endpoints.yml)

### Recommended Status

**✅ Ready for Done - Production Ready**

**Rationale:**
All 9 acceptance criteria are fully implemented and tested. The implementation demonstrates exceptional code quality with:
- ✅ Proper three-tier architecture with clean separation of concerns
- ✅ Excellent code reuse (leverages validated Contact model from Story 2.2)
- ✅ Comprehensive security controls (multi-layer validation, authentication, parameterized queries, system contact protection)
- ✅ Optimized performance (proper indexes, efficient queries, no N+1 issues)
- ✅ High reliability (transactions, error handling, ticket reassignment preserves integrity)
- ✅ Strong maintainability (repository pattern, consistent conventions, JSDoc, reusable methods)
- ✅ Sophisticated soft delete with ticket reassignment and system contact management
- ✅ Complete manual testing (11 comprehensive scenarios including complex edge cases)

The implementation is particularly strong in its use of transactions for the complex soft delete operation, ensuring data integrity through atomic operations (soft delete + system contact creation + ticket reassignment).

**Status Change:** Ready for Done ✅

---

**Previous QA Results:**

**Status**: ✅ Passed

**Verification**:
- All CRUD operations working correctly
- Soft delete preserves ticket history
- System contact auto-created on first deletion
- Tickets reassigned correctly
- Email uniqueness enforced for active contacts
- Email reuse works after soft delete
- Client filtering working
- Authentication requirement enforced
- Validation errors return clear messages
- All manual tests passed
