# Story 2.4: Contact Management API Endpoints

## Status
**Done**

## Story
**As a** developer,
**I want** RESTful API endpoints for contact CRUD operations,
**so that** the frontend can manage contact data.

## Acceptance Criteria
1. `POST /api/contacts` creates new contact (requires valid `client_id`)
2. `GET /api/contacts` returns list of all non-deleted contacts with client information
3. `GET /api/contacts?client_id=X` filters contacts by client
4. `GET /api/contacts/:id` returns single contact with full client details
5. `PUT /api/contacts/:id` updates contact information
6. `DELETE /api/contacts/:id` soft-deletes contact and reassigns all associated tickets to system-created "Deleted Contact" for that client (preserves ticket history)
7. All endpoints require authentication (401 if not logged in)
8. Endpoints return appropriate HTTP status codes and validation error messages
9. API endpoints tested manually or with unit tests

## Tasks / Subtasks
- [x] Task 1: Create contact routes (AC: 1-6, 7)
  - [x] Create backend/src/routes/contact.routes.js
  - [x] Define POST /api/contacts
  - [x] Define GET /api/contacts
  - [x] Define GET /api/contacts/:id
  - [x] Define PUT /api/contacts/:id
  - [x] Define DELETE /api/contacts/:id
  - [x] Apply requireAuth middleware to all routes
- [x] Task 2: Implement create contact endpoint (AC: 1, 8)
  - [x] Create controller method for POST /api/contacts
  - [x] Validate request body (client_id, name, email)
  - [x] Verify client exists
  - [x] Check email uniqueness (for active contacts)
  - [x] Create contact record
  - [x] Return 201 status with created contact
- [x] Task 3: Implement get all contacts endpoint (AC: 2, 3, 8)
  - [x] Create controller method for GET /api/contacts
  - [x] Support optional client_id query parameter
  - [x] Fetch non-deleted contacts with JOIN to clients table
  - [x] Include client name in response
  - [x] Return 200 status with contact array
- [x] Task 4: Implement get contact by ID endpoint (AC: 4, 8)
  - [x] Create controller method for GET /api/contacts/:id
  - [x] Fetch contact with client details
  - [x] Return 200 status with contact object
  - [x] Return 404 if contact not found or deleted
- [x] Task 5: Implement update contact endpoint (AC: 5, 8)
  - [x] Create controller method for PUT /api/contacts/:id
  - [x] Validate request body
  - [x] Check email uniqueness (excluding current contact)
  - [x] Update contact record
  - [x] Return 200 status with updated contact
  - [x] Return 404 if contact not found
- [x] Task 6: Implement soft delete contact endpoint (AC: 6, 8)
  - [x] Create controller method for DELETE /api/contacts/:id
  - [x] Set deleted_at timestamp
  - [x] Get or create system contact for client
  - [x] Reassign all tickets to system contact
  - [x] Return 200 status with reassignment count
- [x] Task 7: Add request validation (AC: 8)
  - [x] Validate client_id (required, valid integer)
  - [x] Validate name (required, max length)
  - [x] Validate email (required, valid format)
  - [x] Return clear error messages
- [x] Task 8: Test all endpoints (AC: 9)
  - [x] Test create contact with valid data
  - [x] Test get all contacts
  - [x] Test filter by client_id
  - [x] Test get contact by ID
  - [x] Test update contact
  - [x] Test soft delete with ticket reassignment
  - [x] Test validation errors
  - [x] Test authentication requirement

## Dev Notes

### Relevant Source Tree
- `backend/src/routes/contact.routes.js` - Contact route definitions
- `backend/src/controllers/contact.controller.js` - Contact request handlers
- `backend/src/models/contact.model.js` - Contact data access layer
- `backend/src/middleware/auth.middleware.js` - Authentication middleware

### API Endpoint Specifications

**1. Create Contact**
```
POST /api/contacts
Content-Type: application/json
Authorization: Required (session cookie)

Request Body:
{
  "clientId": 1,
  "name": "John Doe",
  "email": "john@acme.com"
}

Response: 201 Created
{
  "id": 1,
  "clientId": 1,
  "clientName": "Acme Corp",
  "name": "John Doe",
  "email": "john@acme.com",
  "isSystemContact": false,
  "deletedAt": null,
  "createdAt": "2025-09-30T12:00:00Z"
}
```

**2. Get All Contacts**
```
GET /api/contacts
GET /api/contacts?client_id=1
Authorization: Required (session cookie)

Response: 200 OK
[
  {
    "id": 1,
    "clientId": 1,
    "clientName": "Acme Corp",
    "name": "John Doe",
    "email": "john@acme.com",
    "isSystemContact": false,
    "deletedAt": null,
    "createdAt": "2025-09-30T12:00:00Z",
    "updatedAt": "2025-09-30T12:00:00Z"
  }
]
```

**3. Get Contact by ID**
```
GET /api/contacts/:id
Authorization: Required (session cookie)

Response: 200 OK
{
  "id": 1,
  "clientId": 1,
  "clientName": "Acme Corp",
  "name": "John Doe",
  "email": "john@acme.com",
  "isSystemContact": false,
  "deletedAt": null,
  "createdAt": "2025-09-30T12:00:00Z",
  "updatedAt": "2025-09-30T12:00:00Z"
}

Response: 404 Not Found
{
  "error": "ContactNotFound",
  "message": "Contact not found"
}
```

**4. Update Contact**
```
PUT /api/contacts/:id
Content-Type: application/json
Authorization: Required (session cookie)

Request Body:
{
  "name": "John D. Doe",
  "email": "jdoe@acme.com"
}

Response: 200 OK
{
  "id": 1,
  "clientId": 1,
  "clientName": "Acme Corp",
  "name": "John D. Doe",
  "email": "jdoe@acme.com",
  "isSystemContact": false,
  "deletedAt": null,
  "createdAt": "2025-09-30T12:00:00Z",
  "updatedAt": "2025-09-30T14:00:00Z"
}
```

**5. Delete Contact (Soft Delete)**
```
DELETE /api/contacts/:id
Authorization: Required (session cookie)

Response: 200 OK
{
  "message": "Contact soft-deleted successfully",
  "reassignedTickets": 5,
  "systemContact": {
    "id": 2,
    "name": "Deleted Contact",
    "email": "deleted+1@system.local"
  }
}
```

### Validation Rules
Using express-validator:
```javascript
body('clientId').isInt({ min: 1 })
  .withMessage('Valid client ID is required'),
body('name').trim().isLength({ min: 1, max: 255 })
  .withMessage('Name is required (max 255 characters)'),
body('email').isEmail().normalizeEmail()
  .withMessage('Valid email is required')
```

### Soft Delete Implementation
**System Contact Creation**:
```javascript
// When soft-deleting a contact:
1. Set contact.deleted_at = NOW()
2. Check if system contact exists for client:
   - Email format: `deleted+{client_id}@system.local`
   - Name: "Deleted Contact"
   - is_system_contact: true
3. If not exists, create system contact
4. Reassign all tickets from deleted contact to system contact
5. Return reassignment count
```

**SQL Query for System Contact**:
```sql
SELECT * FROM contacts
WHERE client_id = $1
  AND is_system_contact = true
  AND deleted_at IS NULL
LIMIT 1;
```

**Ticket Reassignment**:
```sql
UPDATE tickets
SET contact_id = $1  -- system contact ID
WHERE contact_id = $2  -- deleted contact ID
RETURNING id;
```

### Architecture Notes
**Soft Delete Benefits**:
- Preserves ticket history
- Allows email reuse (partial unique index excludes deleted)
- Maintains referential integrity
- Audit trail for compliance

**System Contact Pattern**:
- One system contact per client
- Cannot be manually deleted
- UI displays special label "(Deleted Contact)"
- Email pattern prevents conflicts

**Data Transformation**:
- Backend: snake_case (client_id, deleted_at)
- Frontend: camelCase (clientId, deletedAt)
- Transformation in controller layer

### Testing
**Testing Strategy**: Manual testing using cURL or Postman

**Manual Testing Checklist**:
- [x] Create contact: `curl -X POST http://localhost:3001/api/contacts -H "Content-Type: application/json" -d '{"clientId":1,"name":"John Doe","email":"john@acme.com"}'`
- [x] Get all contacts: `curl http://localhost:3001/api/contacts`
- [x] Filter by client: `curl http://localhost:3001/api/contacts?client_id=1`
- [x] Get contact by ID: `curl http://localhost:3001/api/contacts/1`
- [x] Update contact: `curl -X PUT http://localhost:3001/api/contacts/1 -H "Content-Type: application/json" -d '{"name":"Jane Doe","email":"jane@acme.com"}'`
- [x] Delete contact: `curl -X DELETE http://localhost:3001/api/contacts/1`
- [x] Verify system contact created
- [x] Verify tickets reassigned
- [x] Test duplicate email: Should fail
- [x] Test email reuse after delete: Should succeed
- [x] Test without auth: Should return 401

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Contact API endpoints completed | Development Team |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 3.5

### Debug Log References
N/A

### Completion Notes List
- All 5 contact endpoints implemented
- Soft delete with ticket reassignment working
- System contact auto-creation implemented
- Email uniqueness for active contacts enforced
- Request validation with clear error messages
- Authentication middleware applied
- Client filter query parameter working
- All endpoints manually tested
- All acceptance criteria met

### File List
**Created:**
- `backend/src/routes/contact.routes.js` - Route definitions
- `backend/src/controllers/contact.controller.js` - Request handlers

**Modified:**
- `backend/src/index.js` - Added contact routes
- `backend/src/models/contact.model.js` - Added soft delete and system contact methods

## QA Results
**Status**: âœ… Passed

**Verification**:
- All CRUD operations working correctly
- Soft delete preserves ticket history
- System contact auto-created on first deletion
- Tickets reassigned correctly
- Email uniqueness enforced for active contacts
- Email reuse works after soft delete
- Client filtering working
- Authentication requirement enforced
- Validation errors return clear messages
- All manual tests passed
