# Story 1.4: CI/CD Pipeline & Production Deployment

## Status
**Draft**

## Story
**As a** developer,
**I want** automated deployment to production hosting on main branch commits,
**so that** changes are continuously deployed without manual intervention.

## Acceptance Criteria
1. Cloud hosting platform account configured (Heroku/Railway/Render/DigitalOcean)
2. Production PostgreSQL database provisioned on hosting platform
3. CI/CD pipeline configured to deploy on merge to `main` branch
4. Database migrations run automatically on deployment
5. Environment variables configured in hosting platform (DB credentials, session secret)
6. Application accessible via HTTPS URL
7. Health check endpoint returns 200 on production deployment
8. Automated daily database backups configured on hosting platform (NFR7)

## Tasks / Subtasks
- [ ] Task 1: Set up hosting platform account (AC: 1)
  - [ ] Create Railway account
  - [ ] Link GitHub repository
  - [ ] Configure Railway project
- [ ] Task 2: Provision production database (AC: 2)
  - [ ] Create PostgreSQL database on Railway
  - [ ] Configure database connection settings
  - [ ] Verify database connectivity
- [ ] Task 3: Configure CI/CD pipeline (AC: 3, 4)
  - [ ] Set up GitHub Actions workflow
  - [ ] Configure build step for frontend
  - [ ] Configure migration step for database
  - [ ] Set up Railway deployment trigger
- [ ] Task 4: Configure environment variables (AC: 5)
  - [ ] Add DATABASE_URL in Railway
  - [ ] Add SESSION_SECRET (generate strong secret)
  - [ ] Add NODE_ENV=production
  - [ ] Add FRONTEND_URL (production domain)
  - [ ] Add TZ=America/Chicago
- [ ] Task 5: Configure custom domain and HTTPS (AC: 6)
  - [ ] Add CNAME record for tickets.zollc.com
  - [ ] Configure custom domain in Railway
  - [ ] Verify SSL certificate provisioning
  - [ ] Test HTTPS access
- [ ] Task 6: Verify deployment (AC: 7)
  - [ ] Deploy to production
  - [ ] Test health check endpoint
  - [ ] Verify frontend loads correctly
  - [ ] Test login flow on production
- [ ] Task 7: Configure database backups (AC: 8)
  - [ ] Enable automatic backups on Railway PostgreSQL
  - [ ] Verify daily backup schedule
  - [ ] Test backup restoration process
  - [ ] Document backup recovery procedure

## Dev Notes

### Relevant Source Tree
- `.github/workflows/deploy.yml` - GitHub Actions CI/CD pipeline (to be created)
- `backend/src/index.js` - Server with health check endpoint
- Production frontend served from `backend/` as static files

### Architecture Notes
**Platform**: Railway (selected for best balance of simplicity, cost, and features)

**Deployment Architecture**:
- Railway Web Service (Express backend + static frontend)
- Railway PostgreSQL Database
- Region: US-East (optimal latency for Nashville/Central timezone)
- Instance Size: Starter plan (512MB RAM sufficient for MVP)

**Custom Domain**:
- Production URL: `https://tickets.zollc.com`
- CNAME: `tickets.zollc.com` â†’ `<railway-app>.railway.app`

**Build Process**:
1. Frontend builds to `frontend/dist`
2. Backend serves static files from `dist/`
3. API routes at `/api/*`, frontend routes handled by React Router

**Railway Configuration**:
- Build command: `npm install && npm run build --workspace=frontend`
- Start command: `npm start --workspace=backend`
- Auto-deploy on push to `main` branch

### Environment Variables (Production)
Required in Railway dashboard:
- `DATABASE_URL` - Auto-provided by Railway PostgreSQL
- `SESSION_SECRET` - Generate using: `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`
- `NODE_ENV=production`
- `FRONTEND_URL=https://tickets.zollc.com`
- `TZ=America/Chicago`
- `PORT` - Auto-provided by Railway

### CI/CD Pipeline
**GitHub Actions Workflow** (`.github/workflows/deploy.yml`):
```yaml
name: Deploy to Railway

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: npm install
      - name: Build frontend
        run: npm run build --workspace=frontend
      - name: Run tests (when implemented)
        run: npm test
      - name: Deploy to Railway
        uses: railway-app/railway-deploy-action@v1
        with:
          service: ticketing-system
```

**Deployment Flow**:
1. Developer pushes to `main` branch
2. GitHub Actions triggered
3. Install dependencies
4. Build frontend
5. Run tests (when implemented)
6. Railway automatically deploys
7. Railway runs migrations
8. Health check verifies deployment

### Database Backups
**Railway PostgreSQL**:
- Automated daily backups (built-in feature)
- Point-in-time recovery available
- Backups retained for 7-30 days (depending on plan)
- Restoration via Railway dashboard

**Manual Backup** (optional):
```bash
railway run pg_dump $DATABASE_URL > backup-$(date +%Y%m%d).sql
```

### Security Configuration
**Production Security Headers** (via helmet middleware):
- Content-Security-Policy
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Strict-Transport-Security (HSTS)

**Session Security**:
- `secure: true` (HTTPS-only cookies)
- `sameSite: 'lax'`
- `httpOnly: true`

### Monitoring
- Railway built-in logs and metrics
- Health check: `https://tickets.zollc.com/api/health`
- Future: Sentry for error tracking (post-MVP)

### Testing
**Testing Strategy**: Manual verification of deployment

**Production Deployment Checklist**:
- [ ] Railway project created and linked to GitHub
- [ ] Production database provisioned
- [ ] Environment variables configured
- [ ] Custom domain DNS configured
- [ ] SSL certificate provisioned
- [ ] Health endpoint returns 200: `curl https://tickets.zollc.com/api/health`
- [ ] Frontend loads correctly
- [ ] Login flow works on production
- [ ] Database backups enabled
- [ ] Verify auto-deploy on push to main

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Story created | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be completed by dev agent_

### Debug Log References
_To be completed by dev agent_

### Completion Notes List
_To be completed by dev agent_

### File List
_To be completed by dev agent_

## QA Results
_To be completed by QA agent_
