# Story 2.1: Client Data Model & Database Schema

## Status
**Done**

## Story
**As a** developer,
**I want** database tables and models for storing client information,
**so that** the application can persist client data with appropriate relationships and constraints.

## Acceptance Criteria
1. Database migration creates `clients` table with columns: `id`, `company_name`, `xero_customer_id`, `maintenance_contract_type`, `created_at`, `updated_at`
2. Database migration creates `client_domains` table with columns: `id`, `client_id` (foreign key), `domain`, supporting one-to-many relationship
3. Backend models/entities created for Client and ClientDomain with appropriate TypeScript/Python types
4. Database enforces unique constraint on `client_domains.domain` (no domain duplicates across all clients)
5. Cascading delete configured - deleting client removes associated domains
6. Model includes validation rules (e.g., company_name required, domain format validation)
7. Migration runs successfully on local and can be rolled back

## Tasks / Subtasks
- [x] Task 1: Create clients table migration (AC: 1)
  - [x] Write migration for clients table
  - [x] Add columns: id (serial primary key), company_name, xero_customer_id, maintenance_contract_type, created_at, updated_at
  - [x] Add NOT NULL constraints where appropriate
  - [x] Test migration runs successfully
- [x] Task 2: Create client_domains table migration (AC: 2, 4, 5)
  - [x] Write migration for client_domains table
  - [x] Add columns: id (serial primary key), client_id (foreign key), domain, created_at
  - [x] Add foreign key constraint to clients table
  - [x] Add unique constraint on domain column
  - [x] Configure ON DELETE CASCADE for client deletion
- [x] Task 3: Create backend Client model (AC: 3, 6)
  - [x] Create Client model in backend/src/models/client.model.js
  - [x] Implement CRUD methods (create, findAll, findById, update, delete)
  - [x] Add validation for company_name (required)
  - [x] Add domain format validation (regex pattern)
- [x] Task 4: Create backend ClientDomain operations (AC: 3, 6)
  - [x] Add domain management methods to Client model
  - [x] Implement domain creation
  - [x] Implement domain deletion
  - [x] Validate domain format (e.g., example.com)
- [x] Task 5: Test migrations and models (AC: 7)
  - [x] Run migrations on local database
  - [x] Test cascade delete behavior
  - [x] Verify unique constraint on domains
  - [x] Test rollback functionality

## Dev Notes

### Relevant Source Tree
- `backend/src/utils/migrate.js` - Migration system containing clients and client_domains migrations
- `backend/src/models/client.model.js` - Client data access layer

### Database Schema

**Clients Table**:
```sql
CREATE TABLE clients (
  id SERIAL PRIMARY KEY,
  company_name VARCHAR(255) NOT NULL,
  xero_customer_id VARCHAR(255),
  maintenance_contract_type VARCHAR(50) NOT NULL
    CHECK (maintenance_contract_type IN ('Hourly', 'Monthly Retainer', 'Project-Based', 'None')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Client Domains Table**:
```sql
CREATE TABLE client_domains (
  id SERIAL PRIMARY KEY,
  client_id INTEGER NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  domain VARCHAR(255) NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_client_domains_client_id ON client_domains(client_id);
```

### Data Model TypeScript Interfaces
```typescript
export interface Client {
  id: number;
  companyName: string;
  xeroCustomerId: string | null;
  maintenanceContractType: 'Hourly' | 'Monthly Retainer' | 'Project-Based' | 'None';
  domains: string[];
  contactCount?: number; // Computed field
  createdAt: string;
  updatedAt?: string;
}

export interface ClientRequest {
  companyName: string;
  xeroCustomerId?: string;
  maintenanceContractType: 'Hourly' | 'Monthly Retainer' | 'Project-Based' | 'None';
  domains: string[];
}
```

### Validation Rules
**Client**:
- `company_name`: Required, max 255 characters
- `xero_customer_id`: Optional, max 255 characters
- `maintenance_contract_type`: Required, must be one of enum values
- `domains`: Array of valid domain strings

**Domain Validation**:
- Format: `^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`
- Must be unique across all clients
- Example valid domains: `example.com`, `subdomain.example.org`

### Architecture Notes
**Repository Pattern**: Model layer abstracts database access
- Clean separation of concerns
- Testable business logic
- Centralized data validation

**Cascade Behavior**:
- Client deletion cascades to: client_domains, contacts, tickets, time_entries
- Preserves referential integrity
- All related data removed in single transaction

### Testing
**Testing Strategy**: Manual testing for MVP

**Manual Testing Checklist**:
- [x] Run migration: `npm run migrate`
- [x] Verify tables exist: `psql ticketing_system -c "\d clients"`
- [x] Insert test client with domains
- [x] Verify unique constraint: Try inserting duplicate domain (should fail)
- [x] Test cascade delete: Delete client, verify domains removed
- [x] Test validation: Try creating client without company_name (should fail)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Client data model and migrations completed | Development Team |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 3.5

### Debug Log References
N/A

### Completion Notes List
- Clients table migration created successfully
- Client_domains table with foreign key and unique constraint
- Client model with CRUD operations implemented
- Domain validation and management methods added
- Cascade delete configured and tested
- All acceptance criteria met

### File List
**Created:**
- Migration in `backend/src/utils/migrate.js` for clients table
- Migration in `backend/src/utils/migrate.js` for client_domains table
- `backend/src/models/client.model.js` - Client repository

**Modified:**
- `backend/src/utils/migrate.js` - Added new migrations (if applicable)

## QA Results
**Status**: âœ… Passed

**Verification**:
- Both tables created with correct schema
- Foreign key constraints working
- Unique constraint on domain enforced
- Cascade delete functioning correctly
- Model validation rules working
- All CRUD operations tested
