# Story 1.2: Database Setup & Connection

## Status
**Done**

## Story
**As a** developer,
**I want** a PostgreSQL database configured and connected to the backend,
**so that** the application can persist and retrieve data.

## Acceptance Criteria
1. PostgreSQL database provisioned (local development environment)
2. Database connection configuration using environment variables (no hardcoded credentials)
3. Database migration tooling installed (Alembic/Sequelize/TypeORM)
4. Initial migration creates `users` table for authentication
5. Backend can successfully connect to database on startup
6. Database connection health check endpoint (`/api/health`) returns 200 when DB connected
7. Environment variable template (`.env.example`) documented with required DB configuration

## Tasks / Subtasks
- [x] Task 1: Provision PostgreSQL database (AC: 1)
  - [x] Install PostgreSQL locally
  - [x] Create database named `ticketing_system`
  - [x] Verify PostgreSQL is running
- [x] Task 2: Configure database connection (AC: 2)
  - [x] Install pg (node-postgres) library
  - [x] Create database configuration module using environment variables
  - [x] Set up connection pooling
- [x] Task 3: Set up migration tooling (AC: 3)
  - [x] Create custom migration system in backend/src/utils/migrate.js
  - [x] Implement migration tracking mechanism
  - [x] Add npm run migrate script
- [x] Task 4: Create users table migration (AC: 4)
  - [x] Write migration for users table (id, email, password_hash, name, created_at, updated_at)
  - [x] Add unique constraint on email
  - [x] Test migration runs successfully
- [x] Task 5: Implement database connection in backend (AC: 5)
  - [x] Create database pool configuration
  - [x] Add connection initialization on server startup
  - [x] Implement error handling for connection failures
- [x] Task 6: Create health check endpoint (AC: 6)
  - [x] Implement GET /api/health endpoint
  - [x] Add database connectivity check
  - [x] Return 200 status when database connected
- [x] Task 7: Document environment variables (AC: 7)
  - [x] Update backend/.env.example with DB variables
  - [x] Add comments explaining each variable

## Dev Notes

### Relevant Source Tree
- `backend/src/config/database.js` - PostgreSQL connection pool configuration
- `backend/src/utils/migrate.js` - Custom migration system with 8 migrations
- `backend/src/index.js` - Server entry point with health check endpoint
- `backend/.env.example` - Environment variable template

### Architecture Notes
**Database**: PostgreSQL 14+ with connection pooling

**Connection Pooling Configuration**:
```javascript
const pool = new Pool({
  max: 20,                    // Max connections
  idleTimeoutMillis: 10000,   // Close idle connections after 10s
  connectionTimeoutMillis: 2000, // Timeout if no connection available
});
```

**Migration System**: Custom migration system (8 total migrations created):
1. Create users table
2. Create clients table
3. Create client_domains table
4. Create contacts table
5. Create tickets table
6. Create time_entries table
7. Create invoice_locks table
8. Create xero_connections table

**Database Schema - Users Table**:
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Environment Variables
Required in `backend/.env`:
- `DB_HOST=localhost`
- `DB_PORT=5432`
- `DB_NAME=ticketing_system`
- `DB_USER=postgres`
- `DB_PASSWORD=your_password`

### Testing
**Testing Strategy**: Manual testing for MVP

**Manual Testing Checklist**:
- [x] Create local PostgreSQL database: `createdb ticketing_system`
- [x] Configure backend/.env with correct database credentials
- [x] Run migrations: `npm run migrate`
- [x] Start backend: `npm run dev:backend`
- [x] Test health endpoint: `curl http://localhost:3001/api/health` returns 200
- [x] Verify users table exists in database: `psql ticketing_system -c "\dt"`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Database setup and migrations completed | Development Team |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 3.5

### Debug Log References
N/A

### Completion Notes List
- PostgreSQL connection pool configured successfully
- Custom migration system created (simpler than ORM for this project)
- All 8 database migrations created and tested
- Health check endpoint implemented and verified
- Connection error handling added
- Environment variables properly configured

### File List
**Created:**
- `backend/src/config/database.js` - Database pool configuration
- `backend/src/utils/migrate.js` - Migration system with all 8 migrations
- `backend/src/routes/health.js` - Health check endpoint (if separate file)

**Modified:**
- `backend/src/index.js` - Added health check endpoint
- `backend/.env.example` - Added database configuration variables
- `backend/package.json` - Added pg dependency and migrate script

## QA Results
**Status**: âœ… Passed

**Verification**:
- Database connection successful
- Migrations run without errors
- Health endpoint returns 200 status
- Users table created with correct schema
- Environment variables properly configured
- Connection pooling working as expected
