# Story 2.3: Client Management API Endpoints

## Status
**Done**

## Story
**As a** developer,
**I want** RESTful API endpoints for client CRUD operations,
**so that** the frontend can manage client data.

## Acceptance Criteria
1. `POST /api/clients` creates new client with domains (accepts array of domain strings)
2. `GET /api/clients` returns list of all clients with associated domains
3. `GET /api/clients/:id` returns single client with domains and contact count
4. `PUT /api/clients/:id` updates client and replaces domains list
5. `DELETE /api/clients/:id` removes client - returns 403 error if any invoice locks reference this client's tickets, otherwise cascade deletes all contacts, tickets, and time entries with confirmation dialog showing data counts
6. All endpoints require authentication (401 if not logged in)
7. Endpoints return appropriate HTTP status codes (200, 201, 400, 404, 500)
8. Request validation returns clear error messages (e.g., "domain format invalid")
9. API endpoints tested manually using cURL/Postman or unit tests

## Tasks / Subtasks
- [x] Task 1: Create client routes (AC: 1-5, 6)
  - [x] Create backend/src/routes/client.routes.js
  - [x] Define POST /api/clients
  - [x] Define GET /api/clients
  - [x] Define GET /api/clients/:id
  - [x] Define PUT /api/clients/:id
  - [x] Define DELETE /api/clients/:id
  - [x] Apply requireAuth middleware to all routes
- [x] Task 2: Implement create client endpoint (AC: 1, 7, 8)
  - [x] Create controller method for POST /api/clients
  - [x] Validate request body (company_name, maintenance_contract_type, domains)
  - [x] Create client record
  - [x] Create associated domain records
  - [x] Return 201 status with created client
  - [x] Handle validation errors with 400 status
- [x] Task 3: Implement get all clients endpoint (AC: 2, 7)
  - [x] Create controller method for GET /api/clients
  - [x] Fetch all clients with domains
  - [x] Include contact count for each client
  - [x] Return 200 status with client array
- [x] Task 4: Implement get client by ID endpoint (AC: 3, 7)
  - [x] Create controller method for GET /api/clients/:id
  - [x] Fetch client with domains
  - [x] Calculate contact count
  - [x] Return 200 status with client object
  - [x] Return 404 if client not found
- [x] Task 5: Implement update client endpoint (AC: 4, 7, 8)
  - [x] Create controller method for PUT /api/clients/:id
  - [x] Validate request body
  - [x] Update client record
  - [x] Replace domains (delete old, insert new)
  - [x] Return 200 status with updated client
  - [x] Return 404 if client not found
- [x] Task 6: Implement delete client endpoint (AC: 5, 7)
  - [x] Create controller method for DELETE /api/clients/:id
  - [x] Check for invoice locks on client's tickets
  - [x] Return 403 if locked tickets exist
  - [x] Count contacts, tickets, time entries to be deleted
  - [x] Cascade delete all related records
  - [x] Return 200 status with deletion counts
- [x] Task 7: Add request validation (AC: 8)
  - [x] Use express-validator for input validation
  - [x] Validate company_name (required, max length)
  - [x] Validate maintenance_contract_type (enum)
  - [x] Validate domains array and format
  - [x] Return clear error messages
- [x] Task 8: Test all endpoints (AC: 9)
  - [x] Test create client with valid data
  - [x] Test get all clients
  - [x] Test get client by ID
  - [x] Test update client
  - [x] Test delete client (success and locked scenarios)
  - [x] Test validation errors
  - [x] Test authentication requirement

## Dev Notes

### Relevant Source Tree
- `backend/src/routes/client.routes.js` - Client route definitions
- `backend/src/controllers/client.controller.js` - Client request handlers
- `backend/src/models/client.model.js` - Client data access layer
- `backend/src/middleware/auth.middleware.js` - Authentication middleware

### API Endpoint Specifications

**1. Create Client**
```
POST /api/clients
Content-Type: application/json
Authorization: Required (session cookie)

Request Body:
{
  "companyName": "Acme Corp",
  "xeroCustomerId": "123abc",  // Optional
  "maintenanceContractType": "Hourly",
  "domains": ["acme.com", "acmecorp.com"]
}

Response: 201 Created
{
  "id": 1,
  "companyName": "Acme Corp",
  "xeroCustomerId": "123abc",
  "maintenanceContractType": "Hourly",
  "domains": ["acme.com", "acmecorp.com"],
  "contactCount": 0,
  "createdAt": "2025-09-30T12:00:00Z"
}
```

**2. Get All Clients**
```
GET /api/clients
Authorization: Required (session cookie)

Response: 200 OK
[
  {
    "id": 1,
    "companyName": "Acme Corp",
    "xeroCustomerId": "123abc",
    "maintenanceContractType": "Hourly",
    "domains": ["acme.com", "acmecorp.com"],
    "contactCount": 5,
    "createdAt": "2025-09-30T12:00:00Z",
    "updatedAt": "2025-09-30T13:00:00Z"
  }
]
```

**3. Get Client by ID**
```
GET /api/clients/:id
Authorization: Required (session cookie)

Response: 200 OK
{
  "id": 1,
  "companyName": "Acme Corp",
  "xeroCustomerId": "123abc",
  "maintenanceContractType": "Hourly",
  "domains": ["acme.com", "acmecorp.com"],
  "contactCount": 5,
  "createdAt": "2025-09-30T12:00:00Z",
  "updatedAt": "2025-09-30T13:00:00Z"
}

Response: 404 Not Found
{
  "error": "ClientNotFound",
  "message": "Client not found"
}
```

**4. Update Client**
```
PUT /api/clients/:id
Content-Type: application/json
Authorization: Required (session cookie)

Request Body:
{
  "companyName": "Acme Corporation",
  "xeroCustomerId": "123abc",
  "maintenanceContractType": "Monthly Retainer",
  "domains": ["acme.com", "acmecorp.com", "acme.net"]
}

Response: 200 OK
{
  "id": 1,
  "companyName": "Acme Corporation",
  "xeroCustomerId": "123abc",
  "maintenanceContractType": "Monthly Retainer",
  "domains": ["acme.com", "acmecorp.com", "acme.net"],
  "contactCount": 5,
  "createdAt": "2025-09-30T12:00:00Z",
  "updatedAt": "2025-09-30T14:00:00Z"
}
```

**5. Delete Client**
```
DELETE /api/clients/:id
Authorization: Required (session cookie)

Response: 200 OK (success)
{
  "message": "Client deleted successfully",
  "deletedCounts": {
    "contacts": 5,
    "tickets": 12,
    "timeEntries": 48
  }
}

Response: 403 Forbidden (has locked invoices)
{
  "error": "ClientHasLockedInvoices",
  "message": "Cannot delete client with locked invoices",
  "lockedMonths": ["2025-08", "2025-09"]
}
```

### Validation Rules
Using express-validator:
```javascript
body('companyName').trim().isLength({ min: 1, max: 255 })
  .withMessage('Company name is required (max 255 characters)'),
body('maintenanceContractType')
  .isIn(['Hourly', 'Monthly Retainer', 'Project-Based', 'None'])
  .withMessage('Invalid contract type'),
body('domains').isArray({ max: 50 })
  .withMessage('Domains must be an array (max 50)'),
body('domains.*').matches(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/)
  .withMessage('Invalid domain format')
```

### Error Response Format
All errors follow consistent structure:
```json
{
  "error": "ValidationError",
  "message": "Company name is required"
}
```

### Architecture Notes
**Data Transformation**: Backend uses snake_case, frontend expects camelCase
- Transformation handled in controller layer
- Example: `company_name` (DB) → `companyName` (API response)

**Transaction Handling**:
- Client creation wraps client + domain inserts in transaction
- Client update wraps update + domain replacement in transaction
- Client deletion wraps cascade deletes in transaction

### Testing
**Testing Strategy**: Manual testing using cURL or Postman

**Manual Testing Checklist**:
- [x] Create client: `curl -X POST http://localhost:3001/api/clients -H "Content-Type: application/json" -d '{"companyName":"Acme","maintenanceContractType":"Hourly","domains":["acme.com"]}'`
- [x] Get all clients: `curl http://localhost:3001/api/clients`
- [x] Get client by ID: `curl http://localhost:3001/api/clients/1`
- [x] Update client: `curl -X PUT http://localhost:3001/api/clients/1 -H "Content-Type: application/json" -d '{"companyName":"Acme Corp","maintenanceContractType":"Monthly Retainer","domains":["acme.com","acme.net"]}'`
- [x] Delete client: `curl -X DELETE http://localhost:3001/api/clients/1`
- [x] Test without auth: Should return 401
- [x] Test invalid data: Should return 400 with error message
- [x] Test delete locked client: Should return 403

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Client API endpoints completed | Development Team |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 3.5

### Debug Log References
N/A

### Completion Notes List
- All 5 client endpoints implemented
- Request validation using express-validator
- Authentication middleware applied
- Transaction handling for multi-step operations
- Invoice lock checking for delete endpoint
- Cascade deletion with counts returned
- Error handling with consistent format
- All endpoints manually tested
- All acceptance criteria met

### File List
**Created:**
- `backend/src/routes/client.routes.js` - Route definitions
- `backend/src/controllers/client.controller.js` - Request handlers

**Modified:**
- `backend/src/index.js` - Added client routes
- `backend/src/models/client.model.js` - Added methods as needed

## QA Results
**Status**: ✅ Passed

**Verification**:
- All CRUD operations working correctly
- Authentication requirement enforced
- Validation errors return clear messages
- Invoice lock check prevents deletion
- Cascade deletion working properly
- HTTP status codes appropriate
- Error responses follow standard format
- All manual tests passed
