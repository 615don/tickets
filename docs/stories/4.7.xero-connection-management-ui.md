# Story 4.7: Xero Connection Management UI

## Status
**Done**

## Story
**As a** user,
**I want** to connect and manage my Xero integration,
**so that** I can authenticate the application with my Xero account.

## Acceptance Criteria
1. Settings or Admin page includes Xero connection section
2. If not connected: "Connect to Xero" button initiates OAuth flow
3. OAuth flow redirects to Xero login/authorization page
4. After authorization, user redirected back to app with success message
5. If connected: Display connection status, organization name, and last sync timestamp
6. "Disconnect" button available to revoke Xero connection
7. Connection test button to verify credentials still valid
8. Error messages displayed for connection failures (invalid credentials, network errors)
9. Help text explains why Xero connection is required

## Tasks / Subtasks

**Note:** All tasks for this story were already completed as part of Story 4.1 (Xero OAuth Configuration & Connection). This story represents the user-facing UI component of that implementation.

- [x] Task 1: Verify Settings page includes Xero connection section (AC: 1, 9)
  - [x] Confirm `/settings` route exists and is protected by authentication
  - [x] Verify SettingsSection component displays "Xero Integration" section
  - [x] Verify help text explains Xero integration purpose
  - [x] Implemented in Story 4.1 - `frontend/src/components/Settings.tsx:163-176`

- [x] Task 2: Verify "Connect to Xero" button functionality (AC: 2, 3)
  - [x] Confirm "Connect to Xero" button visible when `isConnected === false`
  - [x] Verify button triggers `xeroApi.initiateConnect()` which redirects to `/api/xero/connect`
  - [x] Verify OAuth flow redirects to Xero login page
  - [x] Implemented in Story 4.1 - `frontend/src/components/Settings.tsx:73-75`

- [x] Task 3: Verify OAuth callback success handling (AC: 4)
  - [x] Confirm callback handler in Settings component processes `?success=true` query param
  - [x] Verify success toast message displayed: "Connected to Xero"
  - [x] Verify connection status refetched after successful OAuth
  - [x] Implemented in Story 4.1 - `frontend/src/components/Settings.tsx:37-50`

- [x] Task 4: Verify connection status display (AC: 5)
  - [x] Confirm XeroConnectionCard displays organization name when connected
  - [x] Verify last sync timestamp displayed
  - [x] Verify connection status indicator visible
  - [x] Implemented in Story 4.1 - `frontend/src/components/Settings.tsx:168-175`

- [x] Task 5: Verify "Disconnect" button functionality (AC: 6)
  - [x] Confirm "Disconnect" button visible when `isConnected === true`
  - [x] Verify button triggers `disconnectMutation.mutateAsync()`
  - [x] Verify disconnect confirmation dialog shown before action
  - [x] Verify success toast displayed after disconnect
  - [x] Implemented in Story 4.1 - `frontend/src/components/Settings.tsx:111-126`

- [x] Task 6: Verify connection test functionality (AC: 7)
  - [x] Confirm "Test Connection" button exists in XeroConnectionCard
  - [x] Verify test triggers status refetch via `handleTest()`
  - [x] Verify loading state shown during test (`isTesting`)
  - [x] Verify success/failure toast messages displayed
  - [x] Implemented in Story 4.1 - `frontend/src/components/Settings.tsx:77-109`

- [x] Task 7: Verify error handling for connection failures (AC: 8)
  - [x] Confirm OAuth callback error handling for query params: `?error=no_code`, `?error=no_tenant`, `?error=callback_failed`
  - [x] Verify error-specific messages displayed via toast
  - [x] Verify test connection failure shows error toast
  - [x] Verify disconnect failure shows error toast
  - [x] Implemented in Story 4.1 - `frontend/src/components/Settings.tsx:52-70, 93-97, 119-124`

- [x] Task 8: Manual testing verification (AC: All)
  - [x] Test OAuth flow end-to-end (connect → Xero login → callback → status)
  - [x] Verify connection status displays correctly after successful OAuth
  - [x] Test connection test button shows success message when connected
  - [x] Test disconnect flow clears connection status
  - [x] Test error handling: simulate OAuth errors, test connection errors, disconnect errors
  - [x] Verify help text clearly explains Xero integration purpose
  - [x] Test navigation: Settings link in Navbar, protected route behavior
  - [x] Verified in Story 4.1 completion notes

## Dev Notes

### Story Context

**IMPORTANT: This story's functionality was fully implemented in Story 4.1 (Xero OAuth Configuration & Connection).**

Story 4.1 was a full-stack developer story that implemented both backend OAuth infrastructure AND the user-facing Settings UI. Story 4.7 represents the user-facing subset of that implementation and exists in the epic to reflect the user perspective of the integration.

All acceptance criteria for Story 4.7 are satisfied by the existing implementation in Story 4.1. No additional code needs to be written for this story.

### Previous Story Context

**From Story 4.1 (Xero OAuth Configuration & Connection):**
- Complete OAuth 2.0 flow implemented with xero-node SDK v6.0.0
- Backend routes: `/api/xero/connect`, `/api/xero/callback`, `/api/xero/status`, `/api/xero/disconnect`
- XeroConnection model with AES-256-CBC token encryption
- Frontend Settings page (`/settings`) with XeroConnectionCard component
- React Query hooks: `useXeroStatus()`, `useDisconnectXero()`
- API service layer: `frontend/src/lib/api/xero.ts`
- Token refresh logic and "Consulting Services" validation implemented
- Complete setup documentation in README-XERO-SETUP.md

**From Story 4.4.1 (Invoice Xero Configuration Options):**
- Settings page enhanced with Invoice Configuration section
- Xero invoice status dropdown (DRAFT vs AUTHORISED)
- Invoice configuration API: `GET /api/invoices/config`, `PUT /api/invoices/config`
- React Query hooks: `useInvoiceConfig()`, `useUpdateInvoiceConfig()`

### Implementation Reference

All Story 4.7 acceptance criteria are implemented in the following files from Story 4.1:

**Frontend:**
- **Settings Page:** [frontend/src/components/Settings.tsx](frontend/src/components/Settings.tsx)
  - Lines 163-176: Xero Integration section with help text (AC 1, 9)
  - Lines 73-75: Connect button handler (AC 2, 3)
  - Lines 37-70: OAuth callback handling with success/error messages (AC 4, 8)
  - Lines 168-175: Connection status display (AC 5)
  - Lines 111-126: Disconnect handler (AC 6)
  - Lines 77-109: Connection test handler (AC 7)

- **XeroConnectionCard Component:** [frontend/src/components/XeroConnectionCard.tsx](frontend/src/components/XeroConnectionCard.tsx)
  - Connection status display with organization name and last sync
  - Connect, Test, and Disconnect buttons with proper state management
  - Loading states and success/error indicators

- **API Service Layer:** [frontend/src/lib/api/xero.ts](frontend/src/lib/api/xero.ts)
  - `initiateConnect()`: Redirects to OAuth flow
  - `getStatus()`: Fetches connection status
  - `disconnect()`: Revokes Xero tokens

- **React Query Hooks:** [frontend/src/hooks/useXero.ts](frontend/src/hooks/useXero.ts)
  - `useXeroStatus()`: Query hook for connection status
  - `useDisconnectXero()`: Mutation hook for disconnect action

**Backend:**
- **Xero Routes:** [backend/src/routes/xero.js](backend/src/routes/xero.js)
  - `GET /api/xero/connect`: Initiates OAuth flow
  - `GET /api/xero/callback`: Handles OAuth callback
  - `GET /api/xero/status`: Returns connection status
  - `POST /api/xero/disconnect`: Revokes connection

- **Xero Controller:** [backend/src/controllers/xeroController.js](backend/src/controllers/xeroController.js)
  - OAuth flow logic with state parameter for CSRF protection
  - Token encryption/decryption
  - Connection status retrieval
  - "Consulting Services" validation

- **XeroConnection Model:** [backend/src/models/XeroConnection.js](backend/src/models/XeroConnection.js)
  - Token storage with AES-256-CBC encryption
  - Token refresh logic
  - Connection state management

### Component Architecture

**Settings Page Hierarchy:**
```
Settings (page)
├── PageHeader (title: "Settings")
├── SettingsSection (Xero Integration)
│   └── XeroConnectionCard
│       ├── Connection status display (when connected)
│       │   ├── Organization name
│       │   ├── Last sync timestamp
│       │   └── Connection indicator
│       ├── Connect button (when not connected)
│       ├── Test Connection button (when connected)
│       └── Disconnect button (when connected)
├── SettingsSection (Invoice Configuration)
│   └── Xero Invoice Status dropdown
└── SettingsSection (General)
    └── Billable rate, timezone, date format
```

### User Workflow

**Connect to Xero (AC 2, 3, 4):**
1. User navigates to `/settings`
2. If not connected, "Connect to Xero" button displayed
3. User clicks button → redirects to Xero login/authorization
4. User authorizes app in Xero
5. Xero redirects to `/api/xero/callback?code=AUTH_CODE`
6. Backend exchanges code for tokens, encrypts and stores
7. Backend redirects to `/settings?success=true`
8. Frontend displays success toast and refetches connection status
9. Connection status section updates to show organization name and last sync

**Test Connection (AC 7):**
1. User clicks "Test Connection" button
2. Frontend sets `isTesting = true` (shows loading spinner)
3. Frontend refetches connection status via `GET /api/xero/status`
4. If successful (200 OK): Display success toast
5. If failed (network error, 401, 500): Display error toast
6. Frontend sets `isTesting = false` (hides spinner)

**Disconnect (AC 6):**
1. User clicks "Disconnect" button
2. Confirmation dialog shown (via XeroConnectionCard component)
3. User confirms disconnect
4. Frontend calls `POST /api/xero/disconnect`
5. Backend revokes tokens and deletes connection record
6. Frontend displays success toast and refetches status
7. Connection status section switches to "not connected" state

**Error Handling (AC 8):**
- **OAuth Errors:** Query params `?error=no_code|no_tenant|callback_failed` mapped to user-friendly messages
- **Network Errors:** Test connection failure shows "An error occurred while testing the connection"
- **API Errors:** Disconnect failure shows "Could not disconnect from Xero. Please try again."
- All errors displayed via shadcn/ui Toast component with destructive variant

### Data Models

**XeroConnectionStatus (Frontend Type):**
```typescript
export interface XeroConnectionStatus {
  isConnected: boolean;
  organizationName?: string;
  organizationId?: string;
  connectedAt?: string;
  lastSyncAt?: string;
  isValid: boolean;
  billableRate?: number; // From "Consulting Services" item
}
```

**Backend API Response (`GET /api/xero/status`):**
```json
{
  "isConnected": true,
  "organizationName": "Acme Corp",
  "organizationId": "abc-123-def-456",
  "lastSyncAt": "2025-10-05T10:30:00Z"
}
```

### API Specifications

**GET /api/xero/connect** [Source: Story 4.1]
- **Purpose:** Initiates OAuth 2.0 authorization flow
- **Authentication:** Required (session-based)
- **Response:** 302 Redirect to Xero authorization URL
- **Xero OAuth Scopes:** `accounting.transactions`, `accounting.contacts`

**GET /api/xero/callback** [Source: Story 4.1]
- **Purpose:** Handles OAuth callback from Xero
- **Authentication:** None (public endpoint - OAuth flow)
- **Query Params:**
  - `code`: Authorization code from Xero
  - `state`: CSRF protection token (verified against session)
- **Success:** 302 Redirect to `/settings?success=true`
- **Error:** 302 Redirect to `/settings?error={error_type}`
  - `error=no_code`: No authorization code received
  - `error=no_tenant`: No Xero organization found
  - `error=callback_failed`: Token exchange failed

**GET /api/xero/status** [Source: Story 4.1]
- **Purpose:** Returns current Xero connection status
- **Authentication:** Required
- **Response (200 OK):**
  ```json
  {
    "isConnected": true,
    "organizationName": "Acme Corp",
    "organizationId": "abc-123-def-456",
    "lastSyncAt": "2025-10-05T10:30:00Z"
  }
  ```
- **Response (Not Connected):**
  ```json
  {
    "isConnected": false,
    "organizationName": null,
    "organizationId": null,
    "lastSyncAt": null
  }
  ```

**POST /api/xero/disconnect** [Source: Story 4.1]
- **Purpose:** Revokes Xero tokens and deletes connection
- **Authentication:** Required
- **Response (200 OK):**
  ```json
  {
    "success": true,
    "message": "Xero connection removed successfully"
  }
  ```

### Tech Stack

[Source: docs/architecture/tech-stack.md]

**Frontend:**
- React v18.3.1 - UI library
- TypeScript v5.8.3 - Type safety
- React Query (TanStack Query) v5.83.0 - Server state management
- shadcn/ui - UI components (Dialog, Toast, Button, Card)
- React Router v6.x - Routing and navigation

**Backend:**
- Node.js 18+ LTS - Runtime
- Express v4.18.2 - HTTP server
- xero-node v6.0.0 - Official Xero SDK
- PostgreSQL 14+ - Database for XeroConnection model
- express-session v1.17.3 - Session management

**Key Libraries:**
- bcrypt v5.1.1 - Not used in this story
- Node.js crypto module - AES-256-CBC token encryption

### Coding Standards

[Source: docs/architecture/coding-standards.md]

**Naming Conventions:**
- Components: PascalCase → `XeroConnectionCard.tsx`
- Hooks: camelCase with 'use' → `useXeroStatus.ts`
- API Routes: kebab-case → `/api/xero/connect`
- Database Tables: snake_case → `xero_connections`

**Critical Rules:**
- API Calls: Always use service layer (`frontend/src/lib/api/xero.ts`)
- Environment Variables: Access via config module, never `process.env` directly
- Error Handling: Standard format `{ error: "ErrorType", message: "..." }`
- State Updates: Never mutate state directly (React Query handles immutability)

### Relevant Source Tree

[Source: docs/architecture/unified-project-structure.md]

All files already exist from Story 4.1:

```
frontend/src/
├── components/
│   ├── Settings.tsx                    # Main settings page (READ ONLY - already complete)
│   ├── XeroConnectionCard.tsx          # Connection status card (READ ONLY)
│   ├── SettingsSection.tsx             # Section wrapper (READ ONLY)
│   └── ui/                             # shadcn/ui primitives
├── hooks/
│   └── useXero.ts                      # React Query hooks (READ ONLY)
├── lib/
│   └── api/
│       └── xero.ts                     # API service layer (READ ONLY)
└── types/
    └── xero.ts                         # TypeScript types (READ ONLY)

backend/src/
├── controllers/
│   └── xeroController.js               # OAuth handlers (READ ONLY)
├── routes/
│   └── xero.js                         # Xero API routes (READ ONLY)
├── models/
│   └── XeroConnection.js               # Database model (READ ONLY)
└── config/
    └── xero.js                         # Xero configuration (READ ONLY)
```

**Note:** All files are READ ONLY for this story. No modifications needed.

### Security

[Source: docs/architecture/security-and-performance.md, Story 4.1 QA Review]

**Token Protection:**
- Access tokens NEVER sent to frontend
- Tokens encrypted at rest using AES-256-CBC
- Encryption key stored in `ENCRYPTION_KEY` environment variable
- Frontend only receives connection status (boolean, org name, timestamps)

**CSRF Protection:**
- OAuth state parameter generated and verified (prevents callback hijacking)
- Session-based authentication for all routes except callback
- Callback route validates state parameter against session

**Rate Limiting:**
- OAuth endpoints protected with rate limiting (5 requests per 15 minutes)
- Prevents brute force attacks on OAuth flow

**Input Validation:**
- Callback parameters validated before use
- Query params sanitized to prevent injection

### Testing

[Source: docs/architecture/testing-strategy.md]

**Testing Approach:**
- MVP uses manual testing (no automated tests required for this story)
- All functionality already verified in Story 4.1 completion

**Manual Testing Checklist (Already Completed in Story 4.1):**
- [x] OAuth flow completes successfully (connect → Xero login → callback → status)
- [x] Connection status displays organization name correctly
- [x] Test connection button shows success message when connected
- [x] Disconnect flow clears connection status and shows success message
- [x] Error handling works for OAuth errors (no_code, no_tenant, callback_failed)
- [x] Error handling works for test connection failures
- [x] Error handling works for disconnect failures
- [x] Help text clearly explains Xero integration purpose
- [x] Navigation: Settings link in Navbar works correctly
- [x] Protected route behavior: redirects to login if not authenticated
- [x] Toast notifications display correctly for all success/error cases
- [x] Loading states shown during async operations (test, disconnect)

### Accessibility

[Source: WCAG 2.1 AA standards, shadcn/ui best practices]

**Implemented in Story 4.1:**
- Semantic HTML elements (button, select, section)
- ARIA labels for interactive elements
- Keyboard navigation support (Tab, Enter, Esc)
- Focus management for dialogs and buttons
- Color contrast meets WCAG AA standards (4.5:1)
- Loading states announced to screen readers via ARIA live regions
- Error messages associated with form controls
- Button states (disabled, loading) clearly indicated

### Performance Considerations

**React Query Caching:**
- Connection status cached with 5-minute `staleTime`
- Background refetching on window focus
- Automatic cache invalidation after disconnect mutation

**Optimistic Updates:**
- Disconnect mutation optimistically updates UI before server response
- Rollback on error (mutation error handling)

**Page Load Performance:**
- Settings page loads in <1 second (per NFR2)
- Connection status fetched in parallel with page render
- No blocking operations during initial render

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Story created - all functionality already implemented in Story 4.1 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

N/A - No development work required

### Debug Log References

N/A - All functionality already implemented in Story 4.1

### Completion Notes

**Story 4.7 Status: Complete via Story 4.1 Implementation**

This story exists in Epic 4 to represent the user-facing perspective of the Xero connection management feature. All acceptance criteria were fully satisfied by Story 4.1 (Xero OAuth Configuration & Connection), which implemented both the backend OAuth infrastructure AND the frontend Settings UI as a complete full-stack story.

**Verification Completed:**
- ✅ AC 1: Settings page includes Xero connection section with help text
- ✅ AC 2: "Connect to Xero" button visible when not connected
- ✅ AC 3: OAuth flow redirects to Xero authorization page
- ✅ AC 4: Success message displayed after OAuth callback
- ✅ AC 5: Connection status shows organization name and last sync
- ✅ AC 6: "Disconnect" button available when connected
- ✅ AC 7: "Test Connection" button verifies credentials
- ✅ AC 8: Error messages displayed for all failure scenarios
- ✅ AC 9: Help text explains Xero integration purpose

**Implementation Files (from Story 4.1):**
- frontend/src/components/Settings.tsx
- frontend/src/components/XeroConnectionCard.tsx
- frontend/src/hooks/useXero.ts
- frontend/src/lib/api/xero.ts
- backend/src/routes/xero.js
- backend/src/controllers/xeroController.js
- backend/src/models/XeroConnection.js

**No additional development required for Story 4.7.**

### File List

**No files modified for Story 4.7** - all functionality exists from Story 4.1

**Reference Implementation (Story 4.1):**
- frontend/src/components/Settings.tsx (OAuth callback handling, connection status display)
- frontend/src/components/XeroConnectionCard.tsx (UI component for connection management)
- frontend/src/hooks/useXero.ts (React Query hooks for status and disconnect)
- frontend/src/lib/api/xero.ts (API service layer)
- backend/src/routes/xero.js (OAuth routes)
- backend/src/controllers/xeroController.js (OAuth handlers)
- backend/src/models/XeroConnection.js (Database model with token encryption)

## QA Results

### Review Date: 2025-10-05

### Reviewed By: Bob (Scrum Master)

### Code Quality Assessment

**Overall Quality: N/A (No Code Written)**

This story represents user-facing functionality that was fully implemented in Story 4.1. All acceptance criteria are satisfied by the existing implementation.

**Verification Method:** Code review of Story 4.1 implementation against Story 4.7 acceptance criteria

### Compliance Check

- ✅ **All ACs Met**: PASS
  - All 9 acceptance criteria verified against existing implementation
  - Settings page includes complete Xero connection management UI
  - OAuth flow, error handling, and connection testing all functional

- ✅ **Implementation Quality**: PASS (per Story 4.1 QA Review)
  - Story 4.1 passed comprehensive QA review with grade "READY FOR PRODUCTION"
  - Security concerns addressed: config validation, rate limiting, CSRF protection, input validation
  - Code quality exceeds standards per Story 4.1 QA assessment

- ✅ **Testing Strategy**: PASS
  - Manual testing completed in Story 4.1
  - All user workflows verified
  - Error handling tested for all scenarios

### Requirements Traceability

**AC 1: Settings page includes Xero connection section**
- **Implemented In:** frontend/src/components/Settings.tsx:163-176
- **Status:** ✅ Verified - SettingsSection with title "Xero Integration" and description

**AC 2: "Connect to Xero" button when not connected**
- **Implemented In:** frontend/src/components/XeroConnectionCard.tsx (via Settings.tsx:73-75)
- **Status:** ✅ Verified - Button triggers `xeroApi.initiateConnect()`

**AC 3: OAuth flow redirects to Xero**
- **Implemented In:** backend/src/controllers/xeroController.js (initiateOAuth handler)
- **Status:** ✅ Verified - 302 redirect to Xero authorization URL

**AC 4: Success message after OAuth**
- **Implemented In:** frontend/src/components/Settings.tsx:37-50
- **Status:** ✅ Verified - Toast notification on `?success=true` query param

**AC 5: Display connection status, org name, last sync**
- **Implemented In:** frontend/src/components/Settings.tsx:168-175 (XeroConnectionCard)
- **Status:** ✅ Verified - organizationName and lastSyncAt displayed when connected

**AC 6: Disconnect button available**
- **Implemented In:** frontend/src/components/Settings.tsx:111-126
- **Status:** ✅ Verified - Button calls disconnect mutation with confirmation

**AC 7: Connection test button**
- **Implemented In:** frontend/src/components/Settings.tsx:77-109
- **Status:** ✅ Verified - Test button refetches status with success/error toast

**AC 8: Error messages for failures**
- **Implemented In:** frontend/src/components/Settings.tsx:52-70, 93-97, 119-124
- **Status:** ✅ Verified - Error handling for OAuth errors, test failures, disconnect failures

**AC 9: Help text explains Xero integration**
- **Implemented In:** frontend/src/components/Settings.tsx:166
- **Status:** ✅ Verified - Description: "Connect your Xero account to enable automatic invoice generation."

### Security Review

**Status: ✅ PASS (per Story 4.1 QA Review)**

Story 4.1 implementation includes:
- Token encryption at rest (AES-256-CBC)
- CSRF protection via OAuth state parameter
- Rate limiting on OAuth endpoints
- Input validation on callback parameters
- Tokens never exposed to frontend
- Session-based authentication for all routes except callback

### Recommended Status

✅ **DONE**

All acceptance criteria met via Story 4.1 implementation. No additional work required. Story 4.7 serves as user-facing documentation of Xero connection management functionality.
